<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2R Course α 管理</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:'Noto Sans JP',sans-serif;background:#0a0a0a;color:#fff;padding:20px}
section{background:#111;padding:16px;border-radius:10px;margin-bottom:16px}
button{padding:6px 10px;border-radius:6px;border:1px solid #333;background:#222;color:#fff}
.list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
.card{background:#181818;padding:10px;border-radius:8px}
.small{font-size:12px;color:#aaa}
</style>
</head>
<body>
<section>
  <div>CSV読み込み</div>
  <input type="file" id="csv" accept=".csv">
</section>
<section>
  <div>問題操作</div>
  <button id="prev">戻る</button>
  <button id="next">次へ</button>
  <button id="skip">スルー</button>
</section>
<section>
  <div>参加者操作</div>
  <div id="players" class="list"></div>
</section>
<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js'
import{getDatabase,ref,onValue,set,update}from'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js'
const app=initializeApp({apiKey:"AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",authDomain:"tokiwaji-open-2nd.firebaseapp.com",databaseURL:"https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"tokiwaji-open-2nd",storageBucket:"tokiwaji-open-2nd.firebasestorage.app",messagingSenderId:"1053108487162",appId:"1:1053108487162:web:1cf8f504522b7e95129a43"})
const db=getDatabase(app)
let participants=[],scores={},qnum=1,lastAction=null
onValue(ref(db,'participants'),s=>{participants=s.exists()?Object.entries(s.val()).map(([id,p])=>({id,...p})).filter(p=>p.course==='α'):[];render()})
onValue(ref(db,'2R/α/group1/scores'),s=>{scores=s.val()||{};render()})
document.getElementById('csv').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{const lines=r.result.split(/\r?\n/).filter(l=>l);const qs=lines.map(l=>{const c=l.split(',');return{question:c[0],answer:c.slice(1).join(',')}});set(ref(db,'2R/α/questions'),qs)};r.readAsText(f,'utf-8')})
document.getElementById('next').onclick=()=>{qnum++;set(ref(db,'2R/α/group1/questionNumber'),qnum)}
document.getElementById('prev').onclick=()=>{qnum=Math.max(1,qnum-1);set(ref(db,'2R/α/group1/questionNumber'),qnum)}
document.getElementById('skip').onclick=()=>{participants.forEach(p=>{const s=scores[p.id];if(s&&s.rest>0)update(ref(db,`2R/α/group1/scores/${p.id}`),{rest:s.rest-1})})}
function render(){const box=document.getElementById('players');box.innerHTML='';participants.forEach(p=>{const s=scores[p.id]||{correct:0,wrong:0,rest:0};const d=document.createElement('div');d.className='card';d.innerHTML=`<div>${p.name}</div><div class="small">○${s.correct} ×${s.wrong} 休み${s.rest}</div><button data-a="c">正解</button><button data-a="w">誤答</button><button data-a="u">戻す</button>`;d.querySelector('[data-a=c]').onclick=()=>{lastAction={id:p.id,type:'c'};update(ref(db,`2R/α/group1/scores/${p.id}`),{correct:(s.correct||0)+1});participants.forEach(o=>{if(o.id!==p.id){const so=scores[o.id];if(so&&so.rest>0)update(ref(db,`2R/α/group1/scores/${o.id}`),{rest:so.rest-1})}})};d.querySelector('[data-a=w]').onclick=()=>{lastAction={id:p.id,type:'w'};update(ref(db,`2R/α/group1/scores/${p.id}`),{wrong:(s.wrong||0)+1,rest:(s.rest||0)+1});participants.forEach(o=>{if(o.id!==p.id){const so=scores[o.id];if(so&&so.rest>0)update(ref(db,`2R/α/group1/scores/${o.id}`),{rest:so.rest-1})}})};d.querySelector('[data-a=u]').onclick=()=>{if(!lastAction||lastAction.id!==p.id)return;if(lastAction.type==='c')update(ref(db,`2R/α/group1/scores/${p.id}`),{correct:Math.max(0,(s.correct||0)-1)});if(lastAction.type==='w')update(ref(db,`2R/α/group1/scores/${p.id}`),{wrong:Math.max(0,(s.wrong||0)-1),rest:Math.max(0,(s.rest||0)-1)});lastAction=null};box.appendChild(d)})}
</script>
</body>
</html>
