<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>常磐路オープン2nd - 2R入力画面</title>
<style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #1a1a1a;
  color: white;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
}
h1 {
  text-align: center;
  margin-bottom: 30px;
  color: #4caf50;
}
.course-selector {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}
.course-btn {
  padding: 15px 30px;
  font-size: 18px;
  font-weight: bold;
  border: 3px solid #555;
  background-color: #2a2a2a;
  color: white;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.3s;
}
.course-btn.active {
  background-color: #4caf50;
  border-color: #4caf50;
}
.group-tabs {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 30px;
}
.group-tab {
  padding: 12px 40px;
  font-size: 16px;
  font-weight: bold;
  border: 2px solid #555;
  background-color: #2a2a2a;
  color: white;
  cursor: pointer;
  border-radius: 5px;
  transition: all 0.3s;
}
.group-tab.active {
  background-color: #2196f3;
  border-color: #2196f3;
}
.question-control {
  background-color: #2a2a2a;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 30px;
  text-align: center;
}
.question-control h2 {
  margin: 0 0 15px 0;
}
.question-control input {
  width: 100px;
  padding: 10px;
  font-size: 18px;
  text-align: center;
  margin: 0 10px;
  background-color: #1a1a1a;
  color: white;
  border: 2px solid #555;
  border-radius: 5px;
}
.participants-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 15px;
}
.participant-card {
  background-color: #2a2a2a;
  border: 2px solid #555;
  border-radius: 10px;
  padding: 20px;
  transition: all 0.3s;
}
.participant-card.rest {
  background-color: #1a1a2a;
  border-color: #4a4a6a;
}
.participant-card.disqualified {
  background-color: #2a1a1a;
  border-color: #6a4a4a;
  opacity: 0.6;
}
.participant-card.winner {
  background-color: #1a2a1a;
  border-color: #4a6a4a;
}
.participant-info {
  margin-bottom: 15px;
}
.participant-name {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 5px;
}
.participant-meta {
  font-size: 14px;
  color: #aaa;
}
.score-display {
  display: flex;
  justify-content: space-around;
  align-items: center;
  margin: 15px 0;
  font-size: 24px;
  font-weight: bold;
}
.score-item {
  text-align: center;
}
.score-label {
  font-size: 14px;
  color: #aaa;
  margin-bottom: 5px;
}
.rest-display {
  text-align: center;
  font-size: 28px;
  margin: 10px 0;
  min-height: 40px;
}
.button-group {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}
.btn {
  flex: 1;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s;
}
.btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
.btn-correct {
  background-color: #4caf50;
  color: white;
}
.btn-correct:hover:not(:disabled) {
  background-color: #66bb6a;
}
.btn-wrong {
  background-color: #f44336;
  color: white;
}
.btn-wrong:hover:not(:disabled) {
  background-color: #ef5350;
}
.btn-win {
  background-color: #ff9800;
  color: white;
}
.btn-win:hover:not(:disabled) {
  background-color: #ffa726;
}
.btn-reset {
  background-color: #9e9e9e;
  color: white;
}
.btn-reset:hover:not(:disabled) {
  background-color: #bdbdbd;
}
.winner-badge {
  background-color: #ff9800;
  color: white;
  padding: 5px 10px;
  border-radius: 5px;
  font-size: 14px;
  font-weight: bold;
  display: inline-block;
  margin-top: 10px;
}
.disqualified-badge {
  background-color: #f44336;
  color: white;
  padding: 5px 10px;
  border-radius: 5px;
  font-size: 14px;
  font-weight: bold;
  display: inline-block;
  margin-top: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>常磐路オープン2nd - 2nd Round 入力画面</h1>
  
  <div class="course-selector">
    <button class="course-btn active" onclick="selectCourse('α')">Course α (5○5×)</button>
    <button class="course-btn" onclick="selectCourse('β')">Course β (5up-down)</button>
    <button class="course-btn" onclick="selectCourse('γ')">Course γ (5 by 5)</button>
  </div>
  
  <div class="group-tabs">
    <button class="group-tab active" onclick="selectGroup(1)">Group 1</button>
    <button class="group-tab" onclick="selectGroup(2)">Group 2</button>
  </div>
  
  <div class="question-control">
    <h2>問題番号</h2>
    <button class="btn btn-wrong" onclick="changeQuestion(-1)" style="width: 60px;">-</button>
    <input type="number" id="questionNumber" value="1" min="1" max="30">
    <button class="btn btn-correct" onclick="changeQuestion(1)" style="width: 60px;">+</button>
    <div style="margin-top: 10px; color: #aaa;">限定問題数: 30問</div>
  </div>
  
  <div id="participantsGrid" class="participants-grid"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getDatabase, ref, get, set, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
  authDomain: "tokiwaji-open-2nd.firebaseapp.com",
  databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tokiwaji-open-2nd",
  storageBucket: "tokiwaji-open-2nd.firebasestorage.app",
  messagingSenderId: "1053108487162",
  appId: "1:1053108487162:web:1cf8f504522b7e95129a43"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let currentCourse = 'α';
let currentGroup = 1;
let participants = [];
let scores = {};

window.selectCourse = function(course) {
  currentCourse = course;
  document.querySelectorAll('.course-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  loadParticipants();
}

window.selectGroup = function(group) {
  currentGroup = group;
  document.querySelectorAll('.group-tab').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  loadParticipants();
}

window.changeQuestion = function(delta) {
  const input = document.getElementById('questionNumber');
  const newValue = parseInt(input.value) + delta;
  if (newValue >= 1 && newValue <= 30) {
    input.value = newValue;
    updateQuestionNumber(newValue);
  }
}

async function updateQuestionNumber(num) {
  await set(ref(database, `2R/${currentCourse}/group${currentGroup}/questionNumber`), num);
  
  Object.keys(scores).forEach(async (pid) => {
    if (scores[pid].rest > 0) {
      scores[pid].rest--;
      await set(ref(database, `2R/${currentCourse}/group${currentGroup}/scores/${pid}/rest`), scores[pid].rest);
    }
  });
}

async function loadParticipants() {
  const snapshot = await get(ref(database, 'participants'));
  if (snapshot.exists()) {
    const data = snapshot.val();
    participants = Object.entries(data)
      .map(([id, p]) => ({ id, ...p }))
      .filter(p => p.course === currentCourse && p.group === currentGroup)
      .sort((a, b) => a.firstRoundRank - b.firstRoundRank);
    
    onValue(ref(database, `2R/${currentCourse}/group${currentGroup}/scores`), (snapshot) => {
      scores = snapshot.val() || {};
      renderParticipants();
    });
    
    onValue(ref(database, `2R/${currentCourse}/group${currentGroup}/questionNumber`), (snapshot) => {
      const qNum = snapshot.val() || 1;
      document.getElementById('questionNumber').value = qNum;
    });
  }
}

function renderParticipants() {
  const grid = document.getElementById('participantsGrid');
  grid.innerHTML = '';
  
  participants.forEach(p => {
    const score = scores[p.id] || { 
      correct: 0, 
      wrong: 0, 
      rest: 0, 
      winOrder: null, 
      disqualified: false,
      x: 0,
      y: 5,
      product: 0
    };
    
    const card = document.createElement('div');
    card.className = 'participant-card';
    if (score.rest > 0) card.classList.add('rest');
    if (score.disqualified) card.classList.add('disqualified');
    if (score.winOrder) card.classList.add('winner');
    
    let scoreHTML = '';
    let restHTML = '';
    let buttonsHTML = '';
    
    if (currentCourse === 'α') {
      scoreHTML = `
        <div class="score-display">
          <div class="score-item">
            <div class="score-label">○</div>
            <div>${score.correct || 0}</div>
          </div>
          <div class="score-item">
            <div class="score-label">×</div>
            <div>${score.wrong || 0}</div>
          </div>
        </div>
      `;
      restHTML = score.rest > 0 ? '⛄️'.repeat(score.rest) : '';
      buttonsHTML = `
        <button class="btn btn-correct" onclick="handleCorrect('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>正解 (+1○)</button>
        <button class="btn btn-wrong" onclick="handleWrong('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>誤答 (5問休み)</button>
      `;
    } else if (currentCourse === 'β') {
      scoreHTML = `
        <div class="score-display">
          <div class="score-item">
            <div class="score-label">○</div>
            <div>${score.correct || 0}</div>
          </div>
          <div class="score-item">
            <div class="score-label">×</div>
            <div>${score.wrong || 0}</div>
          </div>
        </div>
      `;
      restHTML = '';
      buttonsHTML = `
        <button class="btn btn-correct" onclick="handleCorrect('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>正解 (+1○)</button>
        <button class="btn btn-wrong" onclick="handleWrong('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>誤答</button>
      `;
    } else if (currentCourse === 'γ') {
      scoreHTML = `
        <div class="score-display">
          <div class="score-item">
            <div class="score-label">X</div>
            <div>${score.x || 0}</div>
          </div>
          <div class="score-item">
            <div class="score-label">Y</div>
            <div>${score.y !== undefined ? score.y : 5}</div>
          </div>
          <div class="score-item">
            <div class="score-label">積</div>
            <div>${score.product || 0}</div>
          </div>
        </div>
      `;
      restHTML = '';
      buttonsHTML = `
        <button class="btn btn-correct" onclick="handleCorrect('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>正解 (X+1)</button>
        <button class="btn btn-wrong" onclick="handleWrong('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>誤答 (Y-1)</button>
      `;
    }
    
    card.innerHTML = `
      <div class="participant-info">
        <div class="participant-name">${p.name}</div>
        <div class="participant-meta">${p.firstRoundRank}位 | ${p.school} | ${p.grade}</div>
      </div>
      ${scoreHTML}
      <div class="rest-display">${restHTML}</div>
      <div class="button-group">
        ${buttonsHTML}
      </div>
      <div class="button-group">
        <button class="btn btn-win" onclick="handleWin('${p.id}')" ${score.winOrder || score.disqualified ? 'disabled' : ''}>勝ち抜け</button>
        <button class="btn btn-reset" onclick="handleReset('${p.id}')">リセット</button>
      </div>
      ${score.winOrder ? `<div class="winner-badge">勝ち抜け ${score.winOrder}位</div>` : ''}
      ${score.disqualified ? `<div class="disqualified-badge">失格</div>` : ''}
    `;
    
    grid.appendChild(card);
  });
}

window.handleCorrect = async function(pid) {
  const score = scores[pid] || { correct: 0, wrong: 0, rest: 0, x: 0, y: 5 };
  
  if (currentCourse === 'α') {
    score.correct++;
    if (score.correct >= 5) {
      const winners = Object.values(scores).filter(s => s.winOrder).length;
      score.winOrder = winners + 1;
    }
  } else if (currentCourse === 'β') {
    score.correct++;
    if (score.correct >= 5) {
      const winners = Object.values(scores).filter(s => s.winOrder).length;
      score.winOrder = winners + 1;
    }
  } else if (currentCourse === 'γ') {
    score.x++;
    score.product = score.x * score.y;
    if (score.product >= 25) {
      const winners = Object.values(scores).filter(s => s.winOrder).length;
      score.winOrder = winners + 1;
    }
  }
  
  await set(ref(database, `2R/${currentCourse}/group${currentGroup}/scores/${pid}`), score);
}

window.handleWrong = async function(pid) {
  const score = scores[pid] || { correct: 0, wrong: 0, rest: 0, x: 0, y: 5 };
  
  if (currentCourse === 'α') {
    score.wrong++;
    score.rest = 5;
  } else if (currentCourse === 'β') {
    score.wrong++;
    if (score.wrong === 1) {
      score.correct = 0;
    } else if (score.wrong >= 2) {
      score.disqualified = true;
    }
  } else if (currentCourse === 'γ') {
    score.wrong++;
    score.y--;
    score.product = score.x * score.y;
    if (score.y <= 2) {
      score.disqualified = true;
    }
  }
  
  await set(ref(database, `2R/${currentCourse}/group${currentGroup}/scores/${pid}`), score);
}

window.handleWin = async function(pid) {
  const score = scores[pid] || { correct: 0, wrong: 0, rest: 0, x: 0, y: 5 };
  const winners = Object.values(scores).filter(s => s.winOrder).length;
  score.winOrder = winners + 1;
  await set(ref(database, `2R/${currentCourse}/group${currentGroup}/scores/${pid}`), score);
}

window.handleReset = async function(pid) {
  if (confirm('この参加者のスコアをリセットしますか？')) {
    const score = { correct: 0, wrong: 0, rest: 0, winOrder: null, disqualified: false, x: 0, y: 5, product: 0 };
    await set(ref(database, `2R/${currentCourse}/group${currentGroup}/scores/${pid}`), score);
  }
}

loadParticipants();
</script>
</body>
</html>