<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>参加者管理画面</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
h1 { margin-bottom: 30px; color: #333; }
.section { margin-bottom: 40px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
.section h2 { margin-bottom: 15px; color: #555; }
.btn { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
.btn-primary { background: #2196f3; color: white; }
.btn-success { background: #4caf50; color: white; }
.btn-warning { background: #ff9800; color: white; }
input[type="file"] { margin: 10px 0; }
input[type="number"] { width: 100px; padding: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
th { background: #f5f5f5; }
.table-wrapper { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; }
select { padding: 5px; }
.info { color: #666; margin: 10px 0; }
</style>
</head>
<body>
<div class="container">
  <h1>常磐路オープン2nd 参加者管理画面</h1>

  <div class="section">
    <h2>1. 参加者データアップロード</h2>
    <p class="info">CSV形式: エントリーナンバー,氏名,学校,学年</p>
    <input type="file" id="csvFile" accept=".csv">
    <p class="info">登録済み: <span id="count">0</span>名</p>
  </div>

  <div class="section">
    <h2>2. 問題データアップロード</h2>
    <p class="info">CSV形式: No.,問題,解答</p>
    <label>最初の問題番号: <input type="number" id="startQ" value="1" min="1"></label>
    <input type="file" id="questionFile" accept=".csv">
    <p class="info">登録済み問題数: <span id="qCount">0</span>問</p>
  </div>

  <div class="section">
    <h2>3. 1st Round得点入力</h2>
    <p class="info">近似値模範解答: <input type="number" id="correctAnswer" placeholder="例: 12345"></p>
    <button class="btn btn-success" onclick="calculate()">得点と順位を計算</button>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>氏名</th>
            <th>学校</th>
            <th>学年</th>
            <th>得点(80点満点)</th>
            <th>近似値解答</th>
            <th>誤差</th>
            <th>1st順位</th>
          </tr>
        </thead>
        <tbody id="firstTable"></tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h2>4. コース振り分け</h2>
    <button class="btn btn-success" onclick="saveAssignment()">振り分けを保存</button>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>氏名</th>
            <th>1st順位</th>
            <th>コース</th>
            <th>グループ</th>
          </tr>
        </thead>
        <tbody id="assignTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getDatabase, ref, set, get, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

const app = initializeApp({
  apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
  authDomain: "tokiwaji-open-2nd.firebaseapp.com",
  databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tokiwaji-open-2nd",
  storageBucket: "tokiwaji-open-2nd.firebasestorage.app",
  messagingSenderId: "1053108487162",
  appId: "1:1053108487162:web:1cf8f504522b7e95129a43"
});

const db = getDatabase(app);
let participants = [];

async function load() {
  const snap = await get(ref(db, 'participants'));
  if (snap.exists()) {
    participants = Object.entries(snap.val()).map(([id, p]) => ({ id, ...p }));
    participants.sort((a, b) => a.entryNumber - b.entryNumber);
    document.getElementById('count').textContent = participants.length;
    loadFirstTable();
    loadAssignTable();
  }
  const qSnap = await get(ref(db, 'questions'));
  if (qSnap.exists()) {
    const qs = Object.keys(qSnap.val());
    document.getElementById('qCount').textContent = qs.length;
  }
}

document.getElementById('csvFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  const lines = text.trim().split('\n');
  const data = {};
  lines.forEach(line => {
    const [num, name, school, grade] = line.split(',').map(s => s.trim());
    const id = `p${num.padStart(3, '0')}`;
    data[id] = { entryNumber: parseInt(num), name, school, grade, score: null, proximityAnswer: null, proximityError: null, rank: null, course: null, group: null };
  });
  await set(ref(db, 'participants'), data);
  alert('アップロード完了');
  load();
});

document.getElementById('questionFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  const lines = text.trim().split('\n');
  const start = parseInt(document.getElementById('startQ').value);
  const data = {};
  lines.forEach((line, i) => {
    const [no, q, a] = line.split(',').map(s => s.trim());
    data[`q${start + i}`] = { number: start + i, question: q, answer: a };
  });
  await set(ref(db, 'questions'), data);
  alert('問題アップロード完了');
  load();
});

function loadFirstTable() {
  const tbody = document.getElementById('firstTable');
  tbody.innerHTML = '';
  participants.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.entryNumber}</td>
      <td>${p.name}</td>
      <td>${p.school}</td>
      <td>${p.grade}</td>
      <td><input type="number" id="score_${p.id}" value="${p.score || ''}" min="0" max="80"></td>
      <td><input type="number" id="prox_${p.id}" value="${p.proximityAnswer || ''}" placeholder="空欄可"></td>
      <td id="error_${p.id}">${p.proximityError !== null ? p.proximityError.toFixed(2) : '-'}</td>
      <td id="rank_${p.id}">${p.rank || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

window.calculate = async function() {
  const correct = parseFloat(document.getElementById('correctAnswer').value);
  if (isNaN(correct)) { alert('近似値模範解答を入力してください'); return; }
  
  const updates = {};
  participants.forEach(p => {
    const score = parseFloat(document.getElementById(`score_${p.id}`).value) || null;
    const prox = document.getElementById(`prox_${p.id}`).value;
    const proxAnswer = prox ? parseFloat(prox) : null;
    const error = proxAnswer !== null ? Math.abs(proxAnswer - correct) : Infinity;
    updates[`participants/${p.id}/score`] = score;
    updates[`participants/${p.id}/proximityAnswer`] = proxAnswer;
    updates[`participants/${p.id}/proximityError`] = error;
  });
  await update(ref(db), updates);
  await load();
  
  const ranked = participants.filter(p => p.score !== null).sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    if (a.proximityError !== b.proximityError) return a.proximityError - b.proximityError;
    return a.entryNumber - b.entryNumber;
  });
  
  const rankUpdates = {};
  ranked.forEach((p, i) => { rankUpdates[`participants/${p.id}/rank`] = i + 1; });
  await update(ref(db), rankUpdates);
  alert('計算完了');
  load();
}

function loadAssignTable() {
  const tbody = document.getElementById('assignTable');
  tbody.innerHTML = '';
  const ranked = participants.filter(p => p.rank !== null).sort((a, b) => a.rank - b.rank);
  ranked.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.entryNumber}</td>
      <td>${p.name}</td>
      <td>${p.rank}</td>
      <td>
        <select id="course_${p.id}">
          <option value="">未設定</option>
          <option value="3R" ${p.course === '3R' ? 'selected' : ''}>3R</option>
          <option value="α" ${p.course === 'α' ? 'selected' : ''}>α</option>
          <option value="β" ${p.course === 'β' ? 'selected' : ''}>β</option>
          <option value="γ" ${p.course === 'γ' ? 'selected' : ''}>γ</option>
        </select>
      </td>
      <td>
        <select id="group_${p.id}" ${p.course === '3R' ? 'disabled' : ''}>
          <option value="">-</option>
          <option value="1" ${p.group === 1 ? 'selected' : ''}>1</option>
          <option value="2" ${p.group === 2 ? 'selected' : ''}>2</option>
        </select>
      </td>
    `;
    tbody.appendChild(tr);
    document.getElementById(`course_${p.id}`).addEventListener('change', function(e) {
      document.getElementById(`group_${p.id}`).disabled = (e.target.value === '3R');
      if (e.target.value === '3R') document.getElementById(`group_${p.id}`).value = '';
    });
  });
}

window.saveAssignment = async function() {
  const updates = {};
  participants.forEach(p => {
    const course = document.getElementById(`course_${p.id}`)?.value || null;
    const group = course === '3R' ? null : (document.getElementById(`group_${p.id}`)?.value ? parseInt(document.getElementById(`group_${p.id}`).value) : null);
    updates[`participants/${p.id}/course`] = course;
    updates[`participants/${p.id}/group`] = group;
  });
  await update(ref(db), updates);
  alert('保存完了');
  load();
}

load();
</script>
</body>
</html>
