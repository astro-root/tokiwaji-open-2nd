<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>参加者管理画面</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
h1 { margin-bottom: 30px; }
.section { margin-bottom: 40px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
.btn { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; }
.btn-success { background: #4caf50; color: white; }
input[type="number"] { width: 100px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 8px; }
th { background: #eee; }
.table-wrapper { max-height: 500px; overflow-y: auto; }
</style>
</head>

<body>
<div class="container">
<h1>常磐路オープン2nd 参加者管理画面</h1>

<div class="section">
<h2>1. 参加者CSV</h2>
<input type="file" id="csvFile" accept=".csv">
<p>登録人数: <span id="count">0</span></p>
</div>

<div class="section">
<h2>2. 問題CSV</h2>
<input type="file" id="questionFile" accept=".csv">
<p>登録問題数: <span id="qCount">0</span></p>
</div>

<div class="section">
<h2>3. 1st Round 得点入力</h2>
近似値模範解答 <input type="number" id="correctAnswer">
<button class="btn btn-success" onclick="calculate()">計算</button>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>No</th><th>氏名</th><th>学校</th><th>学年</th>
<th>得点</th><th>近似値</th><th>誤差</th><th>順位</th>
</tr>
</thead>
<tbody id="firstTable"></tbody>
</table>
</div>
</div>

<div class="section">
<h2>4. コース振り分け</h2>
<button class="btn btn-success" onclick="saveAssignment()">保存</button>

<div class="table-wrapper">
<table>
<thead>
<tr><th>No</th><th>氏名</th><th>順位</th><th>コース</th><th>グループ</th></tr>
</thead>
<tbody id="assignTable"></tbody>
</table>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const app = initializeApp({
apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "tokiwaji-open-2nd"
});

const db = getDatabase(app);
let participants = [];

async function load() {
const snap = await get(ref(db, "participants"));
participants = snap.exists() ? Object.entries(snap.val()).map(([id,p])=>({id,...p})) : [];
participants.sort((a,b)=>a.entryNumber-b.entryNumber);
document.getElementById("count").textContent = participants.length;
loadFirstTable();
loadAssignTable();

const qSnap = await get(ref(db,"questions"));
document.getElementById("qCount").textContent = qSnap.exists() ? Object.keys(qSnap.val()).length : 0;
}

document.getElementById("csvFile").addEventListener("change", async e=>{
const text = await e.target.files[0].text();
const data = {};
text.trim().split("\n").forEach(line=>{
const [n,name,school,grade]=line.split(",");
data["p"+n.padStart(3,"0")]={entryNumber:+n,name,school,grade,score:null,proximityAnswer:null,proximityError:null,rank:null,course:null,group:null};
});
await set(ref(db,"participants"),data);
load();
});

document.getElementById("questionFile").addEventListener("change", async e=>{
const text = await e.target.files[0].text();
const data = {};
text.trim().split("\n").forEach((l,i)=>{
const [,q,a]=l.split(",");
data["q"+(i+1)]={number:i+1,question:q,answer:a};
});
await set(ref(db,"questions"),data);
load();
});

function loadFirstTable(){
const tb=document.getElementById("firstTable");
tb.innerHTML="";
participants.forEach(p=>{
tb.insertAdjacentHTML("beforeend",`
<tr>
<td>${p.entryNumber}</td>
<td>${p.name}</td>
<td>${p.school}</td>
<td>${p.grade}</td>
<td><input type="number" id="s_${p.id}" value="${p.score??""}"></td>
<td><input type="number" id="a_${p.id}" value="${p.proximityAnswer??""}"></td>
<td>${p.proximityError!=null?p.proximityError.toFixed(2):"-"}</td>
<td>${p.rank??"-"}</td>
</tr>`);
});
}

window.calculate=async()=>{
const correct=Number(document.getElementById("correctAnswer").value);
if(!correct)return alert("模範解答を入力してください");
const up={};
participants.forEach(p=>{
const s=Number(document.getElementById("s_"+p.id).value);
const a=document.getElementById("a_"+p.id).value;
up[`participants/${p.id}/score`]=isNaN(s)?null:s;
up[`participants/${p.id}/proximityAnswer`]=a===""?null:Number(a);
up[`participants/${p.id}/proximityError`]=a===""?Infinity:Math.abs(Number(a)-correct);
});
await update(ref(db),up);

const ranked=[...participants].filter(p=>p.score!=null).sort((a,b)=>b.score-a.score||a.proximityError-b.proximityError);
const rUp={};
ranked.forEach((p,i)=>rUp[`participants/${p.id}/rank`]=i+1);
await update(ref(db),rUp);
load();
};

function loadAssignTable(){
const tb=document.getElementById("assignTable");
tb.innerHTML="";
participants.filter(p=>p.rank!=null).sort((a,b)=>a.rank-b.rank).forEach(p=>{
tb.insertAdjacentHTML("beforeend",`
<tr>
<td>${p.entryNumber}</td>
<td>${p.name}</td>
<td>${p.rank}</td>
<td>
<select id="c_${p.id}">
<option value="">未設定</option>
<option value="3R">3R</option>
<option value="α">α</option>
<option value="β">β</option>
<option value="γ">γ</option>
</select>
</td>
<td>
<select id="g_${p.id}">
<option value="">-</option>
<option value="1">1</option>
<option value="2">2</option>
</select>
</td>
</tr>`);
document.getElementById("c_"+p.id).value=p.course??"";
document.getElementById("g_"+p.id).value=p.group??"";
});
}

window.saveAssignment=async()=>{
const up={};
participants.forEach(p=>{
up[`participants/${p.id}/course`]=document.getElementById("c_"+p.id)?.value||null;
const g=document.getElementById("g_"+p.id)?.value;
up[`participants/${p.id}/group`]=g===""?null:Number(g);
});
await update(ref(db),up);
load();
};

load();
</script>
</body>
</html>
