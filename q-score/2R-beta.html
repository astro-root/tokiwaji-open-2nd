<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>常磐路オープン2nd - 2R(Course β)</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Oswald:wght@500;700&family=Roboto+Condensed:wght@700&display=swap');
:root {
--bg-main: #020617;
--bg-panel: #1e293b;
--bg-header: #0f172a;
--text-primary: #f8fafc;
--text-secondary: #94a3b8;
--accent-blue: #3b82f6;
--accent-gold: #f59e0b;
--accent-red: #ef4444;
--accent-green: #22c55e;
--accent-void: #64748b;
--border-color: #334155;
--font-jp: 'Noto Sans JP', sans-serif;
--font-num: 'Oswald', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
html, body { height: 100%; overflow: hidden; background-color: var(--bg-main); color: var(--text-primary); font-family: var(--font-jp); }
body { display: flex; flex-direction: column; }

.bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; opacity: 0.3; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%); overflow: hidden; }
.bg-particle { position: absolute; background: rgba(59, 130, 246, 0.2); border-radius: 50%; animation: float 10s infinite ease-in-out; }
@keyframes float { 0%, 100% { transform: translateY(0) translateX(0); } 50% { transform: translateY(-20px) translateX(10px); } }

header { height: 10vh; flex-shrink: 0; display: flex; align-items: center; background-color: var(--bg-header); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 20; padding: 0 1.5rem; }

.h-left { display: flex; flex-direction: column; justify-content: center; align-items: flex-start; gap: 2px; width: 220px; }
.h-round { font-size: 0.85rem; color: var(--accent-blue); font-weight: 700; letter-spacing: .05em; white-space: nowrap; width: 100%; text-overflow: ellipsis; overflow: hidden; }
.group-badge { 
  background: #1e293b; 
  border: 1px solid var(--border-color); 
  font-size: 1rem; 
  font-weight: 700; 
  border-radius: 4px; 
  letter-spacing: .05em; 
  color: var(--text-primary); 
  text-align: center; 
  height: 26px;
  line-height: 24px;
  width: 100%;
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.h-center { flex: 1; display: flex; justify-content: center; align-items: center; }
.h-rule { font-family: var(--font-num); font-size: 2.2rem; font-weight: 700; line-height: 1; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); }

.h-right { display: flex; align-items: center; gap: 0.8rem; width: auto; justify-content: flex-end; min-width: 220px; height: 100%; }

.q-badge { background: linear-gradient(135deg, var(--accent-blue), #1d4ed8); color: white; padding: 0 0.8rem; height: 80%; min-width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 6px; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
.q-lbl { font-size: .8rem; font-weight: 700; opacity: .9; line-height: 1; display: block; margin-bottom: 2px; }
.q-val { font-family: var(--font-num); font-size: 1.8rem; font-weight: 700; line-height: .9; }
.q-val.pop { transform: scale(1.3); }

.alive-badge { background: linear-gradient(135deg, #475569, #334155); box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 70px; }

.logo-img { height: auto; max-height: 80%; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); margin-left: 10px; object-fit: contain; }

#question-area { height: 25vh; flex-shrink: 0; background: linear-gradient(to bottom, #1e293b, #0f172a); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; padding: 0.5rem 2rem; position: relative; align-items: flex-start; box-shadow: inset 0 -4px 10px rgba(0,0,0,0.3); overflow: hidden; }

.q-ctrls { position: absolute; bottom: .5rem; right: 1rem; display: flex; gap: .5rem; z-index: 10; opacity: .6; transition: opacity .2s; }
.q-ctrls:hover { opacity: 1; }
.sys-btn { background: rgba(255,255,255,.05); border: 1px solid var(--border-color); color: var(--text-secondary); padding: .3rem .6rem; font-size: .75rem; font-weight: 700; border-radius: 4px; cursor: pointer; transition: all .15s ease; }
.sys-btn:hover { background: var(--text-secondary); color: var(--bg-main); }
.sys-btn.btn-void:hover { background: var(--accent-void); color: white; border-color: var(--accent-void); }

#q-text { 
  font-size: 32px; 
  font-weight: 700; 
  text-align: left; 
  line-height: 1.3; 
  width: 100%; 
  color: #fff; 
  text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
  white-space: normal; 
  word-break: break-all;
  flex: 1;
  display: flex;
  align-items: center;
  overflow: hidden;
  margin-bottom: 0.5rem;
}
#q-text.fade-out { opacity: 0; }

.a-container { display: flex; align-items: baseline; gap: 1rem; width: 100%; height: 30px; flex-shrink: 0; overflow: hidden; }
.a-label { font-family: var(--font-num); font-size: 1.1rem; color: var(--accent-blue); font-weight: 700; letter-spacing: .1em; background: rgba(59, 130, 246, 0.1); padding: 1px 6px; border-radius: 4px; flex-shrink: 0; }
#a-text { font-size: 1.4rem; font-weight: 700; text-align: left; color: var(--accent-gold); line-height: 1.1; flex: 1; transition: opacity 0.2s; text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#a-text.fade-out { opacity: 0; }
.ph-q, .ph-a { color: rgba(255,255,255,0.3) !important; font-style: italic; font-weight: 500 !important; text-shadow: none !important; }

#main-content { height: 65vh; display: flex; flex-direction: column; padding: 1rem 1.5rem; overflow: hidden; position: relative; z-index: 1; }
#players-container { flex: 1; display: flex; gap: 0.8rem; width: 100%; height: 100%; justify-content: center; }

.p-card { flex: 1; display: flex; flex-direction: column; background: rgba(30, 41, 59, 0.8); border-radius: 8px; overflow: hidden; position: relative; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border: 1px solid var(--border-color); transition: all 0.3s ease; backdrop-filter: blur(5px); max-width: 20%; }
.p-card:not(.slot-empty) { border-top: 1px solid rgba(255,255,255,0.1); }
.p-card.slot-empty { background: transparent; border: 2px dashed #334155; opacity: .4; box-shadow: none; }
.p-card.is-win { border: 2px solid var(--accent-gold); box-shadow: 0 0 20px rgba(245, 158, 11, 0.3), inset 0 0 20px rgba(245, 158, 11, 0.1); z-index: 5; }

.pc-head { height: 32px; flex-shrink: 0; background: rgba(0,0,0,.3); border-bottom: 1px solid rgba(255,255,255,.05); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
.pc-rank { font-size: 1rem; font-weight: 700; color: #fff; padding: 0 15px; height: 100%; display: flex; align-items: center; justify-content: center; width: 100%; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); letter-spacing: 0.05em; }

.pc-body { flex: 1; position: relative; display: flex; flex-direction: row-reverse; align-items: center; justify-content: center; background: transparent; overflow: hidden; padding: 10px 4px; gap: 8px; }
.pc-tower { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 0.1)); transition: height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 0; height: 0%; pointer-events: none; }

.vertical-text { writing-mode: vertical-rl; text-orientation: upright; white-space: nowrap; display: flex; align-items: center; justify-content: center; z-index: 2; }
.pc-name { font-weight: 700; color: var(--text-primary); font-size: 2.2rem; height: 100%; text-shadow: 2px 2px 4px rgba(0,0,0,.8); letter-spacing: 0.1em; width: 55%; }
.pc-meta { color: #fff; font-size: 1.5rem; height: 100%; font-weight: 700; letter-spacing: 0.1em; width: 35%; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 6px; }

.pc-overlay-lose { position: absolute; inset: 0; z-index: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; }
.p-card.state-lost .pc-overlay-lose { opacity: 1; background: rgba(15,23,42,.85); backdrop-filter: blur(2px); }
.lose-txt { font-family: var(--font-num); font-size: 3rem; color: #64748b; font-weight: 700; transform: rotate(-15deg); border: 3px solid #64748b; padding: 0.5rem 1rem; border-radius: 8px; opacity: 0.8; }

.pc-status { height: 80px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,.2); border-top: 1px solid rgba(255,255,255,.05); z-index: 2; position: relative; }
.pc-score { font-family: var(--font-num); font-size: 3rem; font-weight: 700; line-height: 1; color: var(--text-primary); transition: all 0.2s; text-shadow: 2px 2px 0px rgba(0,0,0,.3); margin-bottom: 4px; }
.pc-score.pop { transform: scale(1.4); color: var(--accent-blue); }
.pc-score.won { color: var(--accent-gold); font-size: 2.5rem; text-shadow: 0 0 15px rgba(245,158,11,.6); }

.pc-wrongs { display: flex; gap: 8px; height: 14px; align-items: center; }
.w-dot { width: 12px; height: 12px; background: #334155; border-radius: 50%; box-shadow: inset 0 1px 3px rgba(0,0,0,.3); transition: all 0.3s ease; }
.w-dot.on { background: linear-gradient(135deg, var(--accent-red), #dc2626); box-shadow: 0 0 8px var(--accent-red); }

.pc-actions { height: 36px; flex-shrink: 0; display: flex; z-index: 10; }
.btn-act { flex: 1; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 900; color: white; transition: all 0.15s ease; position: relative; padding: 0; }
.btn-act:disabled { opacity: .3; cursor: default; filter: grayscale(1); }
.btn-act:not(:disabled):active { transform: scale(0.95); }
.btn-o { background: linear-gradient(to bottom, #059669, #047857); }
.btn-o:not(:disabled):hover { background: linear-gradient(to bottom, #10b981, #059669); }
.btn-x { background: linear-gradient(to bottom, #991b1b, #7f1d1d); }
.btn-x:not(:disabled):hover { background: linear-gradient(to bottom, #ef4444, #991b1b); }

#setup-screen { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; transition: opacity 0.5s ease; }
.setup-box { width: 100%; max-width: 900px; height: 90vh; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); box-shadow: 0 25px 50px -12px rgba(0,0,0,.5); display: flex; flex-direction: column; overflow: hidden; }
.setup-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
.setup-header h2 { font-family: var(--font-num); margin: 0; }
.setup-content { flex: 1; overflow-y: auto; padding: 2rem; }
.setup-footer { padding: 1.5rem; border-top: 1px solid var(--border-color); background: rgba(0,0,0,0.2); flex-shrink: 0; }
.s-row { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
.s-grp { flex: 1; min-width: 140px; display: flex; flex-direction: column; gap: 6px; }
.s-grp label { font-size: .8rem; color: var(--text-secondary); font-weight: 700; }
.s-grp input { width: 100%; background: #0f172a; border: 1px solid var(--border-color); color: #fff; padding: .8rem; font-size: 1.1rem; font-family: var(--font-num); outline: none; border-radius: 4px; transition: border-color 0.2s; }
.s-grp input:focus { border-color: var(--accent-blue); }
.btn-start { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--accent-blue), #2563eb); border: none; font-weight: 700; font-size: 1.2rem; cursor: pointer; font-family: var(--font-jp); border-radius: 6px; color: white; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); letter-spacing: 0.1em; }
.btn-start:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5); }
#player-list { border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; background: rgba(0,0,0,0.2); margin-top: 1rem; }
.player-item { display: flex; gap: 1rem; margin-bottom: .5rem; align-items: center; padding: .5rem; background: rgba(255,255,255,0.05); border-radius: 4px; }
.animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
</style>
</head>
<body>
<div class="bg-animation">
<div class="bg-particle" style="top:20%; left:30%; width:10px; height:10px;"></div>
<div class="bg-particle" style="top:70%; left:80%; width:15px; height:15px; animation-duration:15s;"></div>
<div class="bg-particle" style="top:40%; left:10%; width:8px; height:8px; animation-duration:12s;"></div>
<div class="bg-particle" style="top:80%; left:40%; width:12px; height:12px; animation-duration:18s;"></div>
</div>

<div id="setup-screen">
  <div class="setup-box">
    <div class="setup-header">
      <h2>2R Course β - 設定</h2>
    </div>
    <div class="setup-content">
      <div class="s-row">
        <div class="s-grp" style="flex:2;min-width:200px;">
          <label>グループ名</label>
          <input id="r-name" type="text" value="Group 1" />
        </div>
        <div class="s-grp">
          <label>勝ち抜けpt</label>
          <input id="r-win" type="number" value="5" />
        </div>
        <div class="s-grp">
          <label>勝ち抜け人数</label>
          <input id="r-slot" type="number" value="5" />
        </div>
      </div>
      <div class="s-row">
        <div class="s-grp">
          <label>誤答失格(回)</label>
          <input id="r-max" type="number" value="2" />
        </div>
        <div class="s-grp">
          <label>問題開始番号</label>
          <input id="r-start" type="number" value="1" />
        </div>
        <div class="s-grp">
          <label>限定問題数</label>
          <input id="r-maxq" type="number" value="0" placeholder="0=無制限" />
        </div>
      </div>
      <div class="s-row" style="background:#0f172a;padding:1rem;border-radius:8px;border:1px solid var(--border-color);">
        <div class="s-grp">
          <label>問題(CSV)</label>
          <input id="f-q" type="file" accept=".csv" style="padding: 0.4rem;" />
        </div>
        <div class="s-grp">
          <label>プレイヤー(CSV)</label>
          <input id="f-p" type="file" accept=".csv" style="padding: 0.4rem;" />
        </div>
      </div>
      <div id="player-list" style="display:none;">
        <h3 style="margin-bottom:.5rem;font-size:.9rem;color:var(--text-secondary);">参加者の配置設定</h3>
        <div id="player-list-content"></div>
      </div>
    </div>
    <div class="setup-footer">
      <button class="btn-start" onclick="initGame()">GAME ON!</button>
    </div>
  </div>
</div>

<div id="scoreboard-screen" style="display:none;flex-direction:column;height:100%;">
  <header>
    <div class="h-left">
      <div class="h-round">2nd Round / Course β</div>
      <div class="group-badge" id="d-group">Group 1</div>
    </div>

    <div class="h-center">
      <div class="h-rule" id="d-rule">5 Up-Down</div>
    </div>

    <div class="h-right">
      <div class="q-badge">
        <span class="q-lbl" id="d-q-lbl">Q.</span>
        <span class="q-val" id="d-qnum">1</span>
      </div>

      <div class="q-badge alive-badge">
         <span class="q-lbl"></span>
         <span class="q-val" id="d-alive-slot" style="font-size:1.6rem;">0▶2</span>
      </div>

      <img class="logo-img" src="https://github.com/astro-root/tokiwaji-open-2nd/blob/main/tokiwaji-open-2nd-logo.png?raw=true" alt="Logo" />
    </div>
  </header>

  <div id="question-area">
    <div class="q-ctrls">
      <button class="sys-btn" onclick="actUndo()">戻る</button>
      <button class="sys-btn btn-void" onclick="actVoid()">廃問</button>
      <button class="sys-btn" onclick="actThru()">スルー</button>
    </div>

    <div id="q-text" class="ph-q">ここに問題が表示されます</div>

    <div class="a-container">
      <span class="a-label">Ans.</span>
      <div id="a-text" class="ph-a">ここに解答が表示されます</div>
    </div>
  </div>

  <div id="main-content">
    <div id="players-container"></div>
  </div>
</div>

<script>
  let state = { qIdx: -1, qNum: 1, qs: [], seats: [], hist: [], done: false, winCnt: 0, domSeats: [] };
  let conf = { win: 5, slots: 5, maxX: 2, maxQ: 0, start: 1 };
  let rawP = [];
  let renderQueued = false;
  let resizeObserver = null;

  function parseCSV(t) {
    return t.trim().split('\n').map(l => {
      const r = [];
      const rx = /(?:,|^)(?:"([^"]*)"|([^",]*))/g;
      let m;
      while ((m = rx.exec(l)) !== null) {
        if (m.index === rx.lastIndex) rx.lastIndex++;
        r.push(m[1] || m[2] || "");
      }
      return r.filter(x => x !== undefined && x != "");
    });
  }

  document.getElementById('f-q').onchange = e => {
    const r = new FileReader();
    r.onload = v => {
      state.qs = parseCSV(v.target.result).map(x => ({ no: x[0], q: x[1], a: x[2] }));
      alert('問題を読み込みました');
    };
    r.readAsText(e.target.files[0]);
  };

  document.getElementById('f-p').onchange = e => {
    const r = new FileReader();
    r.onload = v => {
      rawP = parseCSV(v.target.result).map((x, i) => ({
        rank: x[0] || "",
        name: x[1] || ('Player ' + (i + 1)),
        sch: x[2] || "",
        gr: x[3] || "",
        col: x[4] || '#334155',
        pos: i + 1
      }));
      displayPlayerList();
      alert('参加者を読み込みました');
    };
    r.readAsText(e.target.files[0]);
  };

  function displayPlayerList() {
    const list = document.getElementById('player-list');
    const content = document.getElementById('player-list-content');
    list.style.display = 'block';
    content.innerHTML = '';
    const maxPos = Math.max(rawP.length, parseInt(document.getElementById('r-slot')?.value || 5));
    
    rawP.forEach((p, i) => {
      const item = document.createElement('div');
      item.className = 'player-item';
      item.draggable = true;
      item.dataset.index = i;
      
      const sel = document.createElement('select');
      sel.style.background = "#0f172a"; sel.style.color="white"; sel.style.border="1px solid #334155";
      for (let k = 1; k <= maxPos; k++) {
        const op = document.createElement('option');
        op.value = k; op.textContent = k;
        if (k === p.pos) op.selected = true;
        sel.appendChild(op);
      }
      sel.onchange = ev => { movePlayerTo(i, parseInt(ev.target.value) - 1); };
      
      item.ondragstart = ev => { ev.dataTransfer.setData('text/plain', String(i)); };
      item.ondragover = ev => { ev.preventDefault(); };
      item.ondrop = ev => { ev.preventDefault(); reorderPlayers(parseInt(ev.dataTransfer.getData('text/plain')), i); };
      
      const span = document.createElement('span');
      span.style.flex = '1';
      span.textContent = `${p.name} (${p.sch})`;
      item.appendChild(sel);
      item.appendChild(span);
      content.appendChild(item);
    });
  }

  function reorderPlayers(from, to) {
    if (from === to) return;
    const moved = rawP.splice(from, 1)[0];
    rawP.splice(to, 0, moved);
    rawP.forEach((p, i) => p.pos = i + 1);
    displayPlayerList();
  }
  
  function movePlayerTo(index, targetIndex) {
    const item = rawP.splice(index, 1)[0];
    rawP.splice(targetIndex, 0, item);
    rawP.forEach((p, i) => p.pos = i + 1);
    displayPlayerList();
  }

  function fitTextVertical(el) {
    if (!el) return;
    const ph = el.clientHeight;
    const pw = el.clientWidth;
    if (ph <= 0) return;
    
    let low = 10, high = 100, best = 10;
    el.style.whiteSpace = 'nowrap';
    
    for (let i = 0; i < 8; i++) {
      const mid = Math.floor((low + high) / 2);
      el.style.fontSize = mid + 'px';
      if (el.scrollHeight <= ph && el.scrollWidth <= pw) { 
          best = mid; low = mid + 1; 
      } else { 
          high = mid - 1; 
      }
    }
    el.style.fontSize = best + 'px';
  }

  function fitQuestionText() {
    const el = document.getElementById('q-text');
    const p = document.getElementById('question-area'); 
    if (!el || !p) return;
    
    const maxHeight = p.clientHeight - 40; 
    let size = 32;
    el.style.fontSize = size + 'px';
    
    while (el.scrollHeight > maxHeight && size > 10) {
        size -= 2;
        el.style.fontSize = size + 'px';
    }
  }

  function adjustFonts() {
    state.domSeats.forEach(dom => {
      if (!dom) return;
      if (dom.nameEl) fitTextVertical(dom.nameEl);
      if (dom.metaEl) fitTextVertical(dom.metaEl);
    });
    fitQuestionText();
  }

  function buildSeatElements() {
    const container = document.getElementById('players-container');
    container.innerHTML = '';
    state.domSeats = [];
    
    state.seats.forEach((p, i) => {
      const root = document.createElement('div');
      root.className = p ? 'p-card' : 'p-card slot-empty';
      if (!p) { container.appendChild(root); state.domSeats.push(null); return; }
      
      const head = document.createElement('div');
      head.className = 'pc-head';
      head.style.background = p.col || '#334155';
      
      const rank = document.createElement('div');
      rank.className = 'pc-rank';
      rank.textContent = p.rank || '';
      head.appendChild(rank);

      const body = document.createElement('div');
      body.className = 'pc-body';
      
      const towerEl = document.createElement('div');
      towerEl.className = 'pc-tower';
      
      const nameEl = document.createElement('div');
      nameEl.className = 'pc-name vertical-text';
      nameEl.textContent = p.name || '';
      
      const metaEl = document.createElement('div');
      metaEl.className = 'pc-meta vertical-text';
      metaEl.textContent = (p.sch || '') + (p.gr ? (' ' + p.gr) : '');

      const overlayLose = document.createElement('div');
      overlayLose.className = 'pc-overlay-lose';
      overlayLose.innerHTML = '<div class="lose-txt">LOSE</div>';

      body.appendChild(metaEl); 
      body.appendChild(nameEl); 
      body.appendChild(towerEl);
      body.appendChild(overlayLose);

      const status = document.createElement('div');
      status.className = 'pc-status';
      const scoreEl = document.createElement('div');
      scoreEl.className = 'pc-score';
      scoreEl.textContent = '0';
      const wrongs = document.createElement('div');
      wrongs.className = 'pc-wrongs';
      status.appendChild(scoreEl);
      status.appendChild(wrongs);

      const actions = document.createElement('div');
      actions.className = 'pc-actions';
      const btnO = document.createElement('button');
      btnO.className = 'btn-act btn-o'; btnO.textContent = '○';
      const btnX = document.createElement('button');
      btnX.className = 'btn-act btn-x'; btnX.textContent = '×';
      
      btnO.onclick = () => actO(i);
      btnX.onclick = () => actX(i);
      
      actions.appendChild(btnO);
      actions.appendChild(btnX);
      
      root.appendChild(head);
      root.appendChild(body);
      root.appendChild(status);
      root.appendChild(actions);
      container.appendChild(root);
      
      state.domSeats.push({ root, nameEl, metaEl, scoreEl, wrongs, btnO, btnX, towerEl });
    });
    
    requestAnimationFrame(adjustFonts);
    if (!resizeObserver) {
        resizeObserver = new ResizeObserver(adjustFonts);
        resizeObserver.observe(container);
        resizeObserver.observe(document.getElementById('question-area'));
    }
  }

  function initGame() {
    conf.win = parseInt(document.getElementById('r-win').value) || 5;
    conf.slots = parseInt(document.getElementById('r-slot').value) || 5;
    conf.maxX = parseInt(document.getElementById('r-max').value) || 2;
    conf.maxQ = parseInt(document.getElementById('r-maxq').value) || 0;
    conf.start = parseInt(document.getElementById('r-start').value) || 1;
    
    state.qNum = conf.start;
    state.qIdx = conf.start - 2;
    
    document.getElementById('d-group').innerText = document.getElementById('r-name').value;
    document.getElementById('d-rule').innerText = `${conf.win} Up-Down`;
    
    const maxPos = Math.max(rawP.length, conf.slots);
    state.seats = Array(maxPos).fill(null);
    
    rawP.forEach(p => {
      const idx = p.pos - 1;
      if (idx >= 0 && idx < state.seats.length) {
        state.seats[idx] = { ...p, sc: 0, wr: 0, st: 'active', wRank: 0 };
      }
    });
    
    const setup = document.getElementById('setup-screen');
    setup.style.opacity = '0';
    setTimeout(() => {
        setup.style.display = 'none';
        document.getElementById('scoreboard-screen').style.display = 'flex';
        buildSeatElements();
        render(); 
    }, 500);
  }

  function ordinal(n) {
    const s = ['th', 'st', 'nd', 'rd'];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
  }

  function render() {
    const wins = state.seats.filter(x => x && x.st === 'won').length;
    const lost = state.seats.filter(x => x && x.st === 'lost').length;
    const valids = state.seats.filter(x => x).length;
    
    const questionsUsed = state.qNum - conf.start;
    const reachedMaxQ = conf.maxQ > 0 && questionsUsed >= conf.maxQ;
    state.done = (wins >= conf.slots) || reachedMaxQ;
    
    const qVal = document.getElementById('d-qnum');
    if (state.done) {
        qVal.innerText = 'END';
    } else {
        qVal.innerText = state.qNum;
    }
    
    const left = Math.max(0, valids - wins - lost);
    const right = Math.max(0, conf.slots - wins);
    document.getElementById('d-alive-slot').innerText = `${left}▶${right}`;
    
    const qEl = document.getElementById('q-text');
    const aEl = document.getElementById('a-text');
    
    if (state.qIdx < 0) {
      qEl.innerText = 'ここに問題が表示されます'; qEl.className = 'ph-q';
      aEl.innerText = 'ここに解答が表示されます'; aEl.className = 'ph-a';
    } else if (state.qs.length > 0) {
      qEl.classList.remove('ph-q'); aEl.classList.remove('ph-a');
      const len = state.qs.length;
      const idx = ((state.qIdx % len) + len) % len;
      qEl.innerText = state.qs[idx].q || 'NO DATA';
      aEl.innerText = state.qs[idx].a || '';
    } else {
      qEl.innerText = 'ここに問題が表示されます'; qEl.className = 'ph-q';
      aEl.innerText = 'ここに解答が表示されます'; aEl.className = 'ph-a';
    }

    for (let i = 0; i < state.seats.length; i++) {
      const p = state.seats[i];
      const dom = state.domSeats[i];
      if (!dom) continue;
      
      if (!p) {
          dom.root.className = 'p-card slot-empty';
          dom.scoreEl.innerText = ''; dom.wrongs.innerHTML = '';
          continue;
      }

      dom.root.classList.remove('slot-empty', 'is-win', 'state-lost');
      dom.scoreEl.classList.remove('won');
      dom.towerEl.style.height = '0%';
      dom.towerEl.style.background = '';
      
      dom.wrongs.innerHTML = '';
      for (let k = 0; k < conf.maxX; k++) {
          const d = document.createElement('div');
          d.className = 'w-dot' + (k < p.wr ? ' on' : '');
          dom.wrongs.appendChild(d);
      }

      if (p.st === 'won') {
          dom.root.classList.add('is-win');
          dom.scoreEl.innerText = ordinal(p.wRank);
          dom.scoreEl.classList.add('won');
          dom.towerEl.style.height = '100%';
          dom.towerEl.style.background = 'linear-gradient(to top, rgba(245, 158, 11, 0.6), rgba(245, 158, 11, 0.2))';
          dom.btnO.disabled = true; dom.btnX.disabled = true;
      } else if (p.st === 'lost') {
          dom.root.classList.add('state-lost');
          dom.scoreEl.innerText = "LOSE";
          dom.btnO.disabled = true; dom.btnX.disabled = true;
      } else {
          dom.scoreEl.innerText = p.sc;
          const pct = Math.min(100, (p.sc / conf.win) * 100);
          dom.towerEl.style.height = pct + '%';
          dom.btnO.disabled = false; dom.btnX.disabled = false;
      }
    }
    adjustFonts();
  }

  function save() {
    state.hist.push(JSON.stringify({ qIdx: state.qIdx, qNum: state.qNum, seats: JSON.parse(JSON.stringify(state.seats)), done: state.done, winCnt: state.winCnt }));
    if (state.hist.length > 20) state.hist.shift();
  }

  function actO(i) {
    if (state.done) return;
    save();
    
    const p = state.seats[i];
    if (p.st !== 'active') return;
    
    p.sc++;
    const dom = state.domSeats[i];
    dom.scoreEl.classList.remove('pop'); void dom.scoreEl.offsetWidth; dom.scoreEl.classList.add('pop');
    
    if (p.sc >= conf.win) {
      state.winCnt++;
      p.st = 'won';
      p.wRank = state.winCnt;
      p.rank = ordinal(state.winCnt);
    }
    
    render();
    nextQ();
  }

  function actX(i) {
    if (state.done) return;
    save();
    
    const p = state.seats[i];
    if (p.st !== 'active') return;
    
    p.wr++;
    p.sc = 0; 
    
    const dom = state.domSeats[i];
    dom.scoreEl.classList.remove('pop'); void dom.scoreEl.offsetWidth; dom.scoreEl.classList.add('pop');
    dom.root.classList.add('animate-shake'); setTimeout(()=>dom.root.classList.remove('animate-shake'), 500);

    if (p.wr >= conf.maxX) {
      p.st = 'lost';
    }
    
    render();
    nextQ();
  }

  function actThru() {
    if (state.done) return;
    save();
    render();
    nextQ();
  }

  function actVoid() {
    if (state.done) return;
    save();
    
    const qEl = document.getElementById('q-text');
    const aEl = document.getElementById('a-text');
    qEl.classList.add('fade-out'); aEl.classList.add('fade-out');
    
    setTimeout(() => {
        state.qIdx++;
        state.qNum++;
        qEl.classList.remove('fade-out');
        aEl.classList.remove('fade-out');
        render();
    }, 250);
  }

  function nextQ() {
    const qEl = document.getElementById('q-text');
    const aEl = document.getElementById('a-text');
    qEl.classList.add('fade-out');
    aEl.classList.add('fade-out');
    setTimeout(() => {
        state.qIdx++;
        state.qNum++;
        qEl.classList.remove('fade-out');
        aEl.classList.remove('fade-out');
        render();
    }, 250);
  }

  function actUndo() {
    if (!state.hist.length) return;
    const prev = JSON.parse(state.hist.pop());
    state.qIdx = prev.qIdx;
    state.qNum = prev.qNum;
    state.seats = prev.seats;
    state.done = prev.done;
    state.winCnt = prev.winCnt;
    render();
  }
</script>
</body>
</html>
