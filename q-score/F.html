<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>常磐路オープン2nd - Final Round</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Oswald:wght@500;700&family=Roboto+Condensed:wght@700&display=swap');
:root {
  --bg-main: #020617;
  --bg-panel: #1e293b;
  --bg-header: #0f172a;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --accent-blue: #3b82f6;
  --accent-gold: #f59e0b;
  --accent-red: #ef4444;
  --accent-green: #22c55e;
  --accent-void: #64748b;
  --border-color: #334155;
  --font-jp: 'Noto Sans JP', sans-serif;
  --font-num: 'Oswald', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
html, body { height: 100%; overflow: hidden; background-color: var(--bg-main); color: var(--text-primary); font-family: var(--font-jp); }
body { display: flex; flex-direction: column; }

.bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; opacity: 0.3; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%); overflow: hidden; }
.bg-particle { display:none; }


header { height: 10vh; flex-shrink: 0; display: flex; align-items: center; background-color: var(--bg-header); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 20; padding: 0 1.5rem; }
.h-left { display: flex; flex-direction: column; justify-content: center; align-items: flex-start; gap: 2px; width: 220px; }
.h-round { font-size: 0.85rem; color: var(--accent-blue); font-weight: 700; letter-spacing: .05em; white-space: nowrap; width: 100%; text-overflow: ellipsis; overflow: hidden; }
.group-badge { background: #1e293b; border: 1px solid var(--border-color); font-size: 1rem; font-weight: 700; border-radius: 4px; letter-spacing: .05em; color: var(--text-primary); text-align: center; height: 26px; line-height: 24px; width: 100%; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.h-center { flex: 1; display: flex; justify-content: center; align-items: center; }
.h-rule { font-family: var(--font-num); font-size: 2.2rem; font-weight: 700; line-height: 1; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2); }
.h-right { display: flex; align-items: center; gap: 0.8rem; width: auto; justify-content: flex-end; min-width: 220px; height: 100%; }
.q-badge { background: linear-gradient(135deg, var(--accent-blue), #1d4ed8); color: white; padding: 0 0.8rem; height: 80%; min-width: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 6px; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
.q-lbl { font-size: .8rem; font-weight: 700; opacity: .9; line-height: 1; display: block; margin-bottom: 2px; }
.q-val { font-family: var(--font-num); font-size: 1.8rem; font-weight: 700; line-height: .9; }
.alive-badge { background: linear-gradient(135deg, #475569, #334155); box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 70px; }
.logo-img { height: auto; max-height: 80%; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); margin-left: 10px; object-fit: contain; }

#question-area { height: 18vh; flex-shrink: 0; background: linear-gradient(to bottom, #1e293b, #0f172a); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; padding: 0.5rem 2rem; position: relative; align-items: flex-start; box-shadow: inset 0 -4px 10px rgba(0,0,0,0.3); overflow: hidden; }
.q-ctrls { position: absolute; bottom: .5rem; right: 1rem; display: flex; gap: .5rem; z-index: 10; opacity: .6; transition: opacity .2s; }
.q-ctrls:hover { opacity: 1; }
.sys-btn { background: rgba(255,255,255,.05); border: 1px solid var(--border-color); color: var(--text-secondary); padding: .3rem .6rem; font-size: .75rem; font-weight: 700; border-radius: 4px; cursor: pointer; transition: all .15s ease; }
.sys-btn:hover { background: var(--text-secondary); color: var(--bg-main); }
.sys-btn.btn-void:hover { background: var(--accent-void); color: white; border-color: var(--accent-void); }
#q-text { font-size: 28px; font-weight: 700; text-align: left; line-height: 1.3; width: 100%; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); white-space: normal; word-break: break-all; flex: 1; display: flex; align-items: center; overflow: hidden; margin-bottom: 0.3rem; }
#q-text.fade-out { opacity: 0; }
.a-container { display: flex; align-items: baseline; gap: 1rem; width: 100%; height: 28px; flex-shrink: 0; overflow: hidden; }
.a-label { font-family: var(--font-num); font-size: 1rem; color: var(--accent-blue); font-weight: 700; letter-spacing: .1em; background: rgba(59, 130, 246, 0.1); padding: 1px 6px; border-radius: 4px; flex-shrink: 0; }
#a-text { font-size: 1.3rem; font-weight: 700; text-align: left; color: var(--accent-gold); line-height: 1.1; flex: 1; transition: opacity 0.2s; text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#a-text.fade-out { opacity: 0; }
.ph-q, .ph-a { color: rgba(255,255,255,0.3) !important; font-style: italic; font-weight: 500 !important; text-shadow: none !important; }

#track-area { height: 20vh; flex-shrink: 0; background: linear-gradient(to bottom, #060f24, #020617); border-bottom: 1px solid var(--border-color); position: relative; overflow: hidden; }
#track-container { position: absolute; inset: 4px 14px; }
#track-svg { position: absolute; inset: 0; width: 100%; height: 100%; overflow: visible; pointer-events: none; }

.runner-dot { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; color: white; transform: translate(-50%, -50%); transition: left 0.4s ease-out, top 0.4s ease-out; z-index: 4; border: 2px solid rgba(255,255,255,0.45); text-shadow: 1px 1px 2px rgba(0,0,0,0.9); box-shadow: 0 2px 10px rgba(0,0,0,0.7); pointer-events: none; }
.runner-dot.is-lost { opacity: 0.25; transition: left 0.3s ease, top 0.3s ease, opacity 0.4s ease; }
.runner-dot.is-won { border-color: var(--accent-gold) !important; animation: winner-pulse 1.2s infinite ease-in-out; }
@keyframes winner-pulse { 0%,100% { opacity:1; } 50% { opacity:0.75; } }
.runner-dot .dot-label { font-size: inherit; line-height: 1; }

#main-content { flex: 1; display: flex; flex-direction: column; padding: 0.5rem 0.7rem; overflow: hidden; position: relative; z-index: 1; }
#players-container {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-auto-rows: 1fr;
  gap: 0.4rem;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.p-card {
  display: flex;
  flex-direction: row;
  align-items: stretch;
  background: rgba(30, 41, 59, 0.85);
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 4px 12px -2px rgba(0,0,0,0.5);
  border: 1px solid var(--border-color);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  
  min-height: 0;
}
.p-card.slot-empty { background: transparent; border: 2px dashed #334155; opacity: .4; box-shadow: none; }
.p-card.is-win { border: 2px solid var(--accent-gold); box-shadow: 0 0 20px rgba(245, 158, 11, 0.3), inset 0 0 20px rgba(245, 158, 11, 0.1); z-index: 5; }

.pc-side-bar {
  width: 30px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 2;
}
.pc-rank {
  writing-mode: vertical-rl;
  text-orientation: mixed;
  font-size: 0.68rem;
  font-weight: 700;
  color: #fff;
  letter-spacing: 0.04em;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
  white-space: nowrap;
  overflow: hidden;
  max-height: 90%;
  text-overflow: ellipsis;
  line-height: 1.2;
}

.pc-info {
  flex: 1;
  display: grid;
  grid-template-rows: auto 1fr auto;
  padding: 3px 8px;
  position: relative;
  overflow: hidden;
  min-width: 0;
  gap: 0;
}

.pc-tower {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: linear-gradient(to right, rgba(59, 130, 246, 0.38), rgba(59, 130, 246, 0.06));
  transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 0;
  width: 0%;
  pointer-events: none;
}

.pc-school {
  display: flex;
  align-items: center;
  gap: 4px;
  z-index: 1;
  position: relative;
  overflow: hidden;
  min-width: 0;
  height: 16px;
  flex-shrink: 0;
}
.pc-grade { font-size: 0.62rem; font-weight: 700; color: var(--accent-blue); white-space: nowrap; flex-shrink: 0; line-height: 1; }
.pc-schname { font-size: 0.65rem; font-weight: 700; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1; min-width: 0; }

.pc-name {
  font-weight: 900;
  color: var(--text-primary);
  font-size: 1.15rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 1;
  position: relative;
  line-height: 1.2;
  text-shadow: 1px 1px 4px rgba(0,0,0,0.9);
  letter-spacing: 0.04em;
  align-self: center;
  min-width: 0;
}

.pc-stage-lbl {
  font-size: 0.55rem;
  color: var(--text-secondary);
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 1;
  position: relative;
  letter-spacing: 0.01em;
  line-height: 1;
  height: 14px;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.pc-wrongs {
  display: flex;
  gap: 3px;
  align-items: center;
  z-index: 1;
  position: relative;
  flex-wrap: nowrap;
  overflow: hidden;
  height: 14px;
  flex-shrink: 0;
}
.w-dot { width: 7px; height: 7px; background: #334155; border-radius: 50%; box-shadow: inset 0 1px 3px rgba(0,0,0,.3); transition: border-color 0.3s ease, box-shadow 0.3s ease; flex-shrink: 0; }
.w-dot.on { background: linear-gradient(135deg, var(--accent-red), #dc2626); box-shadow: 0 0 5px var(--accent-red); }

.pc-score-col {
  width: 62px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-left: 1px solid rgba(255,255,255,0.06);
  padding: 3px 4px;
  z-index: 2;
  position: relative;
  gap: 1px;
}

.pc-score { font-family: var(--font-num); font-size: 1.9rem; font-weight: 700; line-height: 1; color: var(--text-primary); transition: all 0.2s; text-shadow: 1px 1px 0px rgba(0,0,0,.4); display: flex; align-items: baseline; gap: 2px; justify-content: center; }
.pc-score.pop { transform: scale(1.35); color: var(--accent-blue); }
.pc-score.won { color: var(--accent-gold); font-size: 1.4rem; text-shadow: 0 0 12px rgba(245,158,11,.6); }

.pc-overlay-lose, .pc-overlay-rest { position: absolute; inset: 0; z-index: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; }
.p-card.state-lost .pc-overlay-lose { opacity: 1; background: rgba(15,23,42,.90); }
.lose-txt { font-family: var(--font-num); font-size: 1.8rem; color: #64748b; font-weight: 700; transform: rotate(-10deg); border: 3px solid #64748b; padding: 0.2rem 0.6rem; border-radius: 6px; opacity: 0.85; }
.p-card.state-rest .pc-overlay-rest { opacity: 1; background: rgba(0,0,0,0.80); z-index: 4; }
.rest-txt { font-family: var(--font-num); font-size: 2rem; color: var(--accent-red); font-weight: 900; text-shadow: 0 0 12px rgba(0,0,0,0.9); }

.pc-actions { width: 36px; flex-shrink: 0; display: flex; flex-direction: column; z-index: 10; }
.btn-act { flex: 1; border: none; cursor: pointer; font-size: 1rem; font-weight: 900; color: white; transition: all 0.15s ease; position: relative; padding: 0; width: 100%; }
.btn-act:disabled { opacity: .3; cursor: default; }
.btn-act:not(:disabled):active { transform: scale(0.95); }
.btn-o { background: linear-gradient(to bottom, #059669, #047857); }
.btn-o:not(:disabled):hover { background: linear-gradient(to bottom, #10b981, #059669); }
.btn-x { background: linear-gradient(to bottom, #991b1b, #7f1d1d); }
.btn-x:not(:disabled):hover { background: linear-gradient(to bottom, #ef4444, #991b1b); }

#setup-screen { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95);  z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; transition: opacity 0.5s ease; }
.setup-box { width: 100%; max-width: 860px; max-height: 90vh; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); box-shadow: 0 25px 50px -12px rgba(0,0,0,.5); display: flex; flex-direction: column; overflow: hidden; }
.setup-header { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
.setup-header h2 { font-family: var(--font-num); margin: 0; }
.setup-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
.setup-footer { padding: 1.2rem 1.5rem; border-top: 1px solid var(--border-color); background: rgba(0,0,0,0.2); flex-shrink: 0; }
.s-row { display: flex; gap: 1rem; margin-bottom: 1.2rem; flex-wrap: wrap; }
.s-grp { flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 6px; }
.s-grp label { font-size: .8rem; color: var(--text-secondary); font-weight: 700; }
.s-grp input { width: 100%; background: #0f172a; border: 1px solid var(--border-color); color: #fff; padding: .7rem; font-size: 1rem; font-family: var(--font-num); outline: none; border-radius: 4px; transition: border-color 0.2s; }
.s-grp input:focus { border-color: var(--accent-blue); }

.norma-section { margin-bottom: 1.2rem; }
.norma-section > label { font-size: .8rem; color: var(--text-secondary); font-weight: 700; display: block; margin-bottom: 0.5rem; }
.norma-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.4rem; }
.norma-cell { display: flex; flex-direction: column; gap: 4px; }
.norma-cell > label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; text-align: center; }
.norma-cell input { width: 100%; background: #0f172a; border: 1px solid var(--border-color); color: #fff; padding: 0.5rem 0.2rem; font-size: 1.1rem; font-family: var(--font-num); outline: none; border-radius: 4px; text-align: center; transition: border-color 0.2s; }
.norma-cell input:focus { border-color: var(--accent-blue); }

.btn-start { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--accent-blue), #2563eb); border: none; font-weight: 700; font-size: 1.2rem; cursor: pointer; font-family: var(--font-jp); border-radius: 6px; color: white; transition: border-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); letter-spacing: 0.1em; }
.btn-start:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5); }
#player-list { border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; background: rgba(0,0,0,0.2); margin-top: 1rem; }
.player-item { display: flex; gap: 1rem; margin-bottom: .5rem; align-items: center; padding: .5rem; background: rgba(255,255,255,0.05); border-radius: 4px; }
.animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
</style>
</head>
<body>
<div class="bg-animation">
  <div class="bg-particle" style="top:20%; left:30%; width:10px; height:10px;"></div>
  <div class="bg-particle" style="top:70%; left:80%; width:15px; height:15px; animation-duration:15s;"></div>
  <div class="bg-particle" style="top:40%; left:10%; width:8px; height:8px; animation-duration:12s;"></div>
  <div class="bg-particle" style="top:80%; left:40%; width:12px; height:12px; animation-duration:18s;"></div>
</div>

<div id="setup-screen">
  <div class="setup-box">
    <div class="setup-header">
      <h2>Final Round - 設定</h2>
    </div>
    <div class="setup-content">
      <div class="s-row">
        <div class="s-grp">
          <label>限定問題数</label>
          <input id="r-maxq" type="number" value="0" placeholder="0=無制限" />
        </div>
        <div class="s-grp">
          <label>関門到達トリガー人数</label>
          <input id="r-gate-trigger" type="number" value="1" />
        </div>
        <div class="s-grp">
          <label>関門ごとの失格枠追加</label>
          <input id="r-gate-drop" type="number" value="2" />
        </div>
        <div class="s-grp">
          <label>前半の誤答失格(回)</label>
          <input id="r-max-x" type="number" value="4" />
        </div>
        <div class="s-grp">
          <label>後半の休み倍率</label>
          <input id="r-rest-mult" type="number" value="1" />
        </div>
      </div>

      <div class="norma-section">
        <label>区間ごとの正解ノルマ（1区〜10区）</label>
        <div class="norma-grid">
          <div class="norma-cell"><label>1区</label><input id="n1" type="number" value="1" min="1" /></div>
          <div class="norma-cell"><label>2区</label><input id="n2" type="number" value="1" min="1" /></div>
          <div class="norma-cell"><label>3区</label><input id="n3" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>4区</label><input id="n4" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>5区</label><input id="n5" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>6区</label><input id="n6" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>7区</label><input id="n7" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>8区</label><input id="n8" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>9区</label><input id="n9" type="number" value="2" min="1" /></div>
          <div class="norma-cell"><label>10区</label><input id="n10" type="number" value="3" min="1" /></div>
        </div>
      </div>

      <div class="s-row" style="background:#0f172a;padding:1rem;border-radius:8px;border:1px solid var(--border-color);">
        <div class="s-grp">
          <label>問題(CSV)</label>
          <input id="f-q" type="file" accept=".csv" style="padding: 0.4rem;" />
        </div>
        <div class="s-grp">
          <label>プレイヤー(CSV)</label>
          <input id="f-p" type="file" accept=".csv" style="padding: 0.4rem;" />
        </div>
      </div>
      <div id="player-list" style="display:none;">
        <h3 style="margin-bottom:.5rem;font-size:.9rem;color:var(--text-secondary);">参加者の配置設定</h3>
        <div id="player-list-content"></div>
      </div>
    </div>
    <div class="setup-footer">
      <button class="btn-start" onclick="initGame()">GAME ON!</button>
    </div>
  </div>
</div>

<div id="scoreboard-screen" style="display:none;flex-direction:column;height:100%;">
  <header>
    <div class="h-left">
      <div class="h-round" id="d-round">常磐路オープン2nd</div>
      <div class="group-badge" id="d-group">Final Round</div>
    </div>
    <div class="h-center">
      <div class="h-rule">Marathon</div>
    </div>
    <div class="h-right">
      <div class="q-badge">
        <span class="q-lbl" id="d-q-lbl">Q.</span>
        <span class="q-val" id="d-qnum">1</span>
      </div>
      <div class="q-badge alive-badge">
        <span class="q-lbl"></span>
        <span class="q-val" id="d-alive-slot" style="font-size:1.6rem;">0▶1</span>
      </div>
      <img class="logo-img" src="https://github.com/astro-root/tokiwaji-open-2nd/blob/main/tokiwaji-open-2nd-logo.png?raw=true" alt="Logo" />
    </div>
  </header>

  <div id="question-area">
    <div class="q-ctrls">
      <button class="sys-btn" onclick="actUndo()">戻る</button>
      <button class="sys-btn btn-void" onclick="actVoid()">廃問</button>
      <button class="sys-btn" onclick="actThru()">スルー</button>
    </div>
    <div id="q-text" class="ph-q">ここに問題が表示されます</div>
    <div class="a-container">
      <span class="a-label">Ans.</span>
      <div id="a-text" class="ph-a">ここに解答が表示されます</div>
    </div>
  </div>

  <div id="track-area">
    <div id="track-container">
      <svg id="track-svg"></svg>
    </div>
  </div>

  <div id="main-content">
    <div id="players-container"></div>
  </div>
</div>

<script>
let state = { qIdx: -1, qNum: 1, qs: [], seats: [], hist: [], done: false, gateReachCount: 0, dropQuota: 0 };
let conf = { maxQ: 0, kNormas: [1,1,2,2,2,2,2,2,2,3], totalNorma: 19, gateTrigger: 1, gateDrop: 2, maxX: 4, restMult: 1 };
let rawP = [];
let domSeats = [];
let resizeObserver = null;
let cachedGeo = null;
let resizeTimer = null;
let prevSeatsJson = '';

function parseCSV(t) {
  return t.trim().split('\n').map(l => {
    const r = [];
    const rx = /(?:,|^)(?:"([^"]*)"|([^",]*))/g;
    let m;
    while ((m = rx.exec(l)) !== null) {
      if (m.index === rx.lastIndex) rx.lastIndex++;
      r.push(m[1] || m[2] || "");
    }
    return r.filter(x => x !== undefined && x != "");
  });
}

document.getElementById('f-q').onchange = e => {
  const r = new FileReader();
  r.onload = v => { state.qs = parseCSV(v.target.result).map(x => ({ no: x[0], q: x[1], a: x[2] })); alert('問題を読み込みました'); };
  r.readAsText(e.target.files[0]);
};

document.getElementById('f-p').onchange = e => {
  const r = new FileReader();
  r.onload = v => {
    rawP = parseCSV(v.target.result).map((x, i) => ({ rank: x[0]||"", name: x[1]||('Player '+(i+1)), sch: x[2]||"", gr: x[3]||"", col: x[4]||'#334155', pos: i+1 }));
    displayPlayerList();
    alert('参加者を読み込みました');
  };
  r.readAsText(e.target.files[0]);
};

function displayPlayerList() {
  const list = document.getElementById('player-list');
  const content = document.getElementById('player-list-content');
  list.style.display = 'block';
  content.innerHTML = '';
  rawP.forEach((p, i) => {
    const item = document.createElement('div');
    item.className = 'player-item';
    item.draggable = true;
    const sel = document.createElement('select');
    sel.style.cssText = "background:#0f172a;color:white;border:1px solid #334155";
    for (let k = 1; k <= rawP.length; k++) {
      const op = new Option(k, k, false, k === p.pos);
      sel.appendChild(op);
    }
    sel.onchange = ev => { movePlayerTo(i, +ev.target.value - 1); };
    item.ondragstart = ev => ev.dataTransfer.setData('text/plain', String(i));
    item.ondragover = ev => ev.preventDefault();
    item.ondrop = ev => { ev.preventDefault(); reorderPlayers(+ev.dataTransfer.getData('text/plain'), i); };
    const span = document.createElement('span');
    span.style.flex = '1';
    span.textContent = `${p.name}（${p.gr} ${p.sch}）`;
    item.appendChild(sel); item.appendChild(span);
    content.appendChild(item);
  });
}

function reorderPlayers(from, to) {
  if (from === to) return;
  rawP.splice(to, 0, rawP.splice(from, 1)[0]);
  rawP.forEach((p, i) => p.pos = i + 1);
  displayPlayerList();
}

function movePlayerTo(index, targetIndex) {
  rawP.splice(targetIndex, 0, rawP.splice(index, 1)[0]);
  rawP.forEach((p, i) => p.pos = i + 1);
  displayPlayerList();
}

function getTrackGeometry() {
  if (cachedGeo) return cachedGeo;
  const container = document.getElementById('track-container');
  if (!container) return null;
  const cw = container.offsetWidth, ch = container.offsetHeight;
  if (!cw || !ch) return null;
  const cx = cw / 2, cy = ch / 2;
  const r = ch * 0.36;
  const rs = Math.max(0, cw * 0.46 - r);
  cachedGeo = { cx, cy, r, rs, total: 4*rs + 2*Math.PI*r, cw, ch };
  return cachedGeo;
}

function getTrackPos(progress, geo) {
  const { cx, cy, r, rs, total } = geo;
  const d = (((progress % 1) + 1) % 1) * total;
  if (d <= rs)                             return { x: cx + d,                      y: cy + r };
  if (d <= rs + Math.PI*r)               { const t=(d-rs)/r, a=Math.PI/2-t;         return { x: cx+rs+r*Math.cos(a), y: cy+r*Math.sin(a) }; }
  if (d <= 3*rs + Math.PI*r)             { const t=d-rs-Math.PI*r;                  return { x: cx+rs-t,             y: cy - r }; }
  if (d <= 3*rs + 2*Math.PI*r)           { const t=(d-3*rs-Math.PI*r)/r, a=-Math.PI/2-t; return { x: cx-rs+r*Math.cos(a), y: cy+r*Math.sin(a) }; }
  return { x: cx - rs + (d - 3*rs - 2*Math.PI*r), y: cy + r };
}

function stadiumPath(cx, cy, rs, r) {
  if (rs <= 0) return `M ${cx} ${cy+r} A ${r} ${r} 0 1 1 ${cx+.001} ${cy+r} Z`;
  return `M ${cx+rs} ${cy+r} A ${r} ${r} 0 0 0 ${cx+rs} ${cy-r} L ${cx-rs} ${cy-r} A ${r} ${r} 0 0 1 ${cx-rs} ${cy+r} Z`;
}

function drawTrackSVG() {
  const svg = document.getElementById('track-svg');
  const geo = getTrackGeometry();
  if (!svg || !geo) return;
  const { cx, cy, r, rs, cw, ch } = geo;
  svg.setAttribute('viewBox', `0 0 ${cw} ${ch}`);

  const lW = r * 0.22;
  const ri = r - lW * 1.5, ro = r + lW * 1.5;
  let h = `<defs>
    <filter id="ts"><feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#000" flood-opacity="1"/></filter>
  </defs>`;

  h += `<rect width="${cw}" height="${ch}" fill="#050e1c"/>`;
  h += `<path d="${stadiumPath(cx,cy,rs,ro+4)}" fill="#1a2535"/>`;
  h += `<path d="${stadiumPath(cx,cy,rs,ro)}" fill="#1b3325"/>`;
  h += `<path d="${stadiumPath(cx,cy,rs,ri)}" fill="#0d1f12"/>`;

  for (let ln=1; ln<=2; ln++) {
    const rl = ri + (ln/3)*(ro-ri);
    if (rs > 0) {
      h += `<line x1="${cx-rs}" y1="${cy-rl}" x2="${cx+rs}" y2="${cy-rl}" stroke="rgba(255,255,255,0.07)" stroke-width="0.8"/>`;
      h += `<line x1="${cx-rs}" y1="${cy+rl}" x2="${cx+rs}" y2="${cy+rl}" stroke="rgba(255,255,255,0.07)" stroke-width="0.8"/>`;
    }
    h += `<path d="M ${cx+rs} ${cy+rl} A ${rl} ${rl} 0 0 0 ${cx+rs} ${cy-rl}" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="0.8"/>`;
    h += `<path d="M ${cx-rs} ${cy-rl} A ${rl} ${rl} 0 0 1 ${cx-rs} ${cy+rl}" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="0.8"/>`;
  }

  h += `<path d="${stadiumPath(cx,cy,rs,ro)}" fill="none" stroke="rgba(100,160,255,0.3)" stroke-width="1"/>`;
  h += `<path d="${stadiumPath(cx,cy,rs,ri)}" fill="none" stroke="rgba(100,160,255,0.3)" stroke-width="1"/>`;
  h += `<path d="${stadiumPath(cx,cy,rs,r)}"  fill="none" stroke="rgba(59,130,246,0.55)" stroke-width="1.5" stroke-dasharray="6 5"/>`;

  const sgX = cx, sgTop = cy+ri-2, sgBot = cy+ro+2;
  h += `<line x1="${sgX}" y1="${sgTop}" x2="${sgX}" y2="${sgBot}" stroke="rgba(245,158,11,0.9)" stroke-width="2.5"/>`;
  const sgLy = cy+ro+13;
  h += `<rect x="${sgX-16}" y="${sgLy-7}" width="32" height="15" rx="3" fill="rgba(3,8,20,0.95)" stroke="rgba(245,158,11,0.7)" stroke-width="1"/>`;
  h += `<text x="${sgX}" y="${sgLy}" text-anchor="middle" dominant-baseline="middle" font-size="9" font-weight="900" fill="rgba(245,158,11,1)" font-family="Oswald,sans-serif">S/G</text>`;

  let cum = 0;
  for (let i = 0; i < conf.kNormas.length-1; i++) {
    cum += conf.kNormas[i];
    const prog = cum / conf.totalNorma;
    const mp = getTrackPos(prog, geo);
    const ep = 0.0015;
    const ap = getTrackPos(Math.min(prog+ep, 0.9999), geo);
    const dx = ap.x-mp.x, dy = ap.y-mp.y, len = Math.sqrt(dx*dx+dy*dy)||1;
    const px = -dy/len, py = dx/len;
    const tR = lW*1.5+3;
    const isGate = i===4;
    const col = isGate ? 'rgba(245,158,11,0.9)' : 'rgba(180,200,230,0.6)';
    h += `<line x1="${mp.x-px*tR}" y1="${mp.y-py*tR}" x2="${mp.x+px*tR}" y2="${mp.y+py*tR}" stroke="${col}" stroke-width="${isGate?2.5:1.5}"/>`;
    const lR = lW*2.2+10;
    const lx = mp.x+px*lR, ly = mp.y+py*lR;
    h += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" font-size="${isGate?9:8}" font-weight="${isGate?'900':'700'}" fill="${isGate?'rgba(245,158,11,1)':'rgba(190,210,240,0.9)'}" font-family="Noto Sans JP,sans-serif" filter="url(#ts)">${i+1}区</text>`;
  }

  svg.innerHTML = h;
}

function updateRunners() {
  const geo = cachedGeo;
  if (!geo) return;
  const active = [];
  domSeats.forEach((dom, i) => {
    if (!dom?.runnerDot) return;
    const p = state.seats[i];
    if (!p) { dom.runnerDot.style.display = 'none'; return; }
    const prog = conf.totalNorma > 0 ? Math.min(p.totalSc/conf.totalNorma, 0.9999) : 0;
    active.push({ dom, p, pos: getTrackPos(prog, geo), ox:0, oy:0 });
  });

  const n = active.length;
  const dotSize = Math.max(18, Math.min(26, n>0 ? Math.floor(200/n) : 26));
  const fontSize = Math.max(7, Math.floor(dotSize*0.42));
  const minD = dotSize*1.05;

  const visited = new Uint8Array(n);
  for (let i=0; i<n; i++) {
    if (visited[i]) continue;
    const group = [i];
    for (let j=i+1; j<n; j++) {
      if (!visited[j] && Math.hypot(active[j].pos.x-active[i].pos.x, active[j].pos.y-active[i].pos.y) < minD) {
        group.push(j); visited[j]=1;
      }
    }
    visited[i]=1;
    if (group.length > 1) {
      const sp = dotSize*0.52;
      group.forEach((idx,k) => {
        const a = (k/group.length)*2*Math.PI - Math.PI/2;
        active[idx].ox = Math.cos(a)*sp;
        active[idx].oy = Math.sin(a)*sp;
      });
    }
  }

  const dsz = dotSize+'px', fsz = fontSize+'px';
  active.forEach(({ dom, p, pos, ox, oy }) => {
    const dot = dom.runnerDot;
    dot.style.display = 'flex';
    dot.style.width = dsz; dot.style.height = dsz; dot.style.fontSize = fsz;
    dot.style.left = (pos.x+ox)+'px'; dot.style.top = (pos.y+oy)+'px';
    dot.classList.toggle('is-lost', p.st==='lost');
    dot.classList.toggle('is-won',  p.st==='won');
    if (p.st==='lost')      { dot.style.background='#1e293b'; dot.style.border='2px solid #334155'; dot.style.boxShadow='none'; }
    else if (p.st==='won') { dot.style.background=p.col||'#334155'; dot.style.border='2px solid #f59e0b'; dot.style.boxShadow='0 0 12px rgba(245,158,11,0.7)'; }
    else                   { dot.style.background=p.col||'#334155'; dot.style.border='2px solid rgba(255,255,255,0.55)'; dot.style.boxShadow='0 2px 6px rgba(0,0,0,0.7)'; }
  });
}

function buildSeatElements() {
  const container = document.getElementById('players-container');
  container.innerHTML = ''; domSeats = [];
  const trackContainer = document.getElementById('track-container');
  trackContainer.querySelectorAll('.runner-dot').forEach(d => d.remove());

  state.seats.forEach((p, i) => {
    const root = document.createElement('div');
    root.className = p ? 'p-card' : 'p-card slot-empty';
    if (!p) { container.appendChild(root); domSeats.push(null); return; }

    const sideBar = document.createElement('div');
    sideBar.className = 'pc-side-bar'; sideBar.style.background = p.col||'#334155';
    const rankEl = document.createElement('div');
    rankEl.className = 'pc-rank'; rankEl.textContent = p.rank||'';
    sideBar.appendChild(rankEl);

    const infoDiv = document.createElement('div'); infoDiv.className = 'pc-info';
    const towerEl = document.createElement('div'); towerEl.className = 'pc-tower';

    const schoolDiv = document.createElement('div'); schoolDiv.className = 'pc-school';
    const schnameEl = document.createElement('div'); schnameEl.className = 'pc-schname'; schnameEl.textContent = p.sch||'';
    const gradeEl = document.createElement('div'); gradeEl.className = 'pc-grade'; gradeEl.textContent = p.gr||'';
    schoolDiv.appendChild(schnameEl); schoolDiv.appendChild(gradeEl);

    const nameEl = document.createElement('div'); nameEl.className = 'pc-name'; nameEl.textContent = p.name||'';
    const wrongs = document.createElement('div'); wrongs.className = 'pc-wrongs';

    const wdots = [];
    for (let k=0; k<conf.maxX; k++) {
      const d = document.createElement('div'); d.className = 'w-dot'; wrongs.appendChild(d); wdots.push(d);
    }

    infoDiv.appendChild(towerEl); infoDiv.appendChild(schoolDiv); infoDiv.appendChild(nameEl); infoDiv.appendChild(wrongs);

    const scoreCol = document.createElement('div'); scoreCol.className = 'pc-score-col';
    const scoreEl = document.createElement('div'); scoreEl.className = 'pc-score'; scoreEl.textContent = '0';
    const scoreNorm = document.createElement('span'); scoreNorm.style.cssText = 'font-size:0.5em;color:#94a3b8;';
    scoreCol.appendChild(scoreEl);

    const actions = document.createElement('div'); actions.className = 'pc-actions';
    const btnO = document.createElement('button'); btnO.className = 'btn-act btn-o'; btnO.textContent = '○';
    const btnX = document.createElement('button'); btnX.className = 'btn-act btn-x'; btnX.textContent = '×';
    btnO.onclick = () => actO(i); btnX.onclick = () => actX(i);
    actions.appendChild(btnO); actions.appendChild(btnX);

    const overlayLose = document.createElement('div'); overlayLose.className = 'pc-overlay-lose';
    overlayLose.innerHTML = '<div class="lose-txt">LOSE</div>';
    const overlayRest = document.createElement('div'); overlayRest.className = 'pc-overlay-rest';
    const restTxt = document.createElement('div'); restTxt.className = 'rest-txt'; overlayRest.appendChild(restTxt);

    root.appendChild(sideBar); root.appendChild(infoDiv); root.appendChild(scoreCol); root.appendChild(actions);
    root.appendChild(overlayLose); root.appendChild(overlayRest);
    container.appendChild(root);

    const dot = document.createElement('div'); dot.className = 'runner-dot';
    dot.style.background = p.col||'#334155'; dot.style.zIndex = 4;
    dot.innerHTML = `<span class="dot-label">${(p.name||'?').charAt(0)}</span>`;
    dot.title = `${p.name}（${p.gr} ${p.sch}）`;
    trackContainer.appendChild(dot);

    domSeats.push({ root, nameEl, scoreEl, wrongs, btnO, btnX, towerEl, overlayRest, restTxt, runnerDot: dot, popTimer: null });
  });

  cachedGeo = null;
  requestAnimationFrame(() => { getTrackGeometry(); drawTrackSVG(); updateRunners(); });

  if (!resizeObserver) {
    resizeObserver = new ResizeObserver(() => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => { cachedGeo = null; getTrackGeometry(); drawTrackSVG(); updateRunners(); }, 100);
    });
    resizeObserver.observe(document.getElementById('track-container'));
  }
}

function initGame() {
  conf.maxQ = parseInt(document.getElementById('r-maxq').value)||0;
  conf.kNormas = [1,2,3,4,5,6,7,8,9,10].map(k => parseInt(document.getElementById('n'+k).value)||1);
  conf.totalNorma = conf.kNormas.reduce((a,b)=>a+b,0);
  conf.gateTrigger = parseInt(document.getElementById('r-gate-trigger').value)||1;
  conf.gateDrop = parseInt(document.getElementById('r-gate-drop').value)||2;
  conf.maxX = parseInt(document.getElementById('r-max-x').value)||4;
  conf.restMult = parseInt(document.getElementById('r-rest-mult').value)||1;
  state.qNum=1; state.qIdx=-1; state.gateReachCount=0; state.dropQuota=0; state.done=false;
  const maxPos = rawP.length;
  state.seats = Array(maxPos).fill(null);
  rawP.forEach(p => {
    const idx = p.pos-1;
    if (idx>=0 && idx<maxPos) state.seats[idx] = {...p, stage:0, sc:0, totalSc:0, wr:0, totalWr:0, rest:0, st:'active'};
  });
  const setup = document.getElementById('setup-screen');
  setup.style.opacity = '0';
  setTimeout(() => {
    setup.style.display = 'none';
    document.getElementById('scoreboard-screen').style.display = 'flex';
    buildSeatElements(); render();
  }, 500);
}

function applyDrop(exemptIdx) {
  const lostCount = state.seats.filter(x=>x&&x.st==='lost').length;
  let need = state.dropQuota - lostCount;
  if (need<=0) return;
  state.seats.map((p,i)=>({p,i})).filter(x=>x.p&&x.p.st==="active"&&x.i!==exemptIdx)
    .sort((a,b)=>a.p.stage!==b.p.stage?a.p.stage-b.p.stage:a.p.sc!==b.p.sc?a.p.sc-b.p.sc:b.p.totalWr-a.p.totalWr||b.p.pos-a.p.pos)
    .slice(0, need).forEach(x=>x.p.st='lost');
}

function render() {
  const lost = state.seats.filter(x=>x&&x.st==='lost').length;
  const valids = state.seats.filter(x=>x).length;
  document.getElementById('d-alive-slot').innerText = `${Math.max(0,valids-lost)}▶1`;
  document.getElementById('d-qnum').innerText = state.done ? 'END' : state.qNum;

  const qEl = document.getElementById('q-text'), aEl = document.getElementById('a-text');
  if (state.qIdx < 0) {
    qEl.innerText = 'ここに問題が表示されます'; qEl.className = 'ph-q';
    aEl.innerText = 'ここに解答が表示されます'; aEl.className = 'ph-a';
  } else if (state.qs.length > 0) {
    qEl.classList.remove('ph-q'); aEl.classList.remove('ph-a');
    const idx = ((state.qIdx % state.qs.length) + state.qs.length) % state.qs.length;
    qEl.innerText = state.qs[idx].q||'NO DATA'; aEl.innerText = state.qs[idx].a||'';
  }

  for (let i=0; i<state.seats.length; i++) {
    const p = state.seats[i], dom = domSeats[i];
    if (!dom) continue;
    if (!p) { dom.root.className='p-card slot-empty'; continue; }

    dom.root.classList.remove('slot-empty','is-win','state-lost','state-rest');
    dom.btnO.disabled = true; dom.btnX.disabled = true;

    const pct = conf.totalNorma>0 ? Math.min((p.totalSc/conf.totalNorma)*100,100) : 0;
    dom.towerEl.style.width = pct+'%';

    if (p.st==='won') {
      dom.root.classList.add('is-win');
      dom.scoreEl.className = 'pc-score won';
      dom.scoreEl.textContent = 'WIN';
      dom.towerEl.style.background = 'linear-gradient(to right,rgba(245,158,11,0.55),rgba(245,158,11,0.15))';
    } else if (p.st==='lost') {
      dom.root.classList.add('state-lost');
      dom.scoreEl.className = 'pc-score';
      dom.scoreEl.textContent = 'LOSE';
      dom.towerEl.style.background = 'linear-gradient(to right,rgba(59,130,246,0.38),rgba(59,130,246,0.06))';
    } else {
      dom.scoreEl.className = 'pc-score';
      dom.towerEl.style.background = 'linear-gradient(to right,rgba(59,130,246,0.38),rgba(59,130,246,0.06))';
      if (p.rest > 0) {
        dom.root.classList.add('state-rest');
        dom.restTxt.innerText = p.rest+' 休';
      }
      dom.btnO.disabled = false; dom.btnX.disabled = false;
      if (p.stage < conf.kNormas.length) {
        dom.scoreEl.innerHTML = `${p.sc}<span style="font-size:0.5em;color:#94a3b8;"> / ${conf.kNormas[p.stage]}</span>`;
      } else {
        dom.scoreEl.textContent = 'GOAL';
      }
    }

    dom.wrongs.innerHTML = '';
    if (p.st !== 'lost') {
      if (p.stage < 5) {
        for (let k=0; k<conf.maxX; k++) {
          const d = document.createElement('div');
          d.className = 'w-dot' + (k<p.wr ? ' on' : '');
          dom.wrongs.appendChild(d);
        }
      } else {
        dom.wrongs.innerHTML = `<span style="color:#ef4444;font-size:0.8rem;font-weight:bold">通算×: ${p.totalWr}</span>`;
      }
    }
  }

  updateRunners();
}

function save() {
  state.hist.push(JSON.stringify(state));
  if (state.hist.length > 50) state.hist.shift();
}

function progressRest() {
  state.seats.forEach(sp => { if (sp&&sp.st==='active'&&sp.rest>0) sp.rest--; });
}

function triggerPop(dom) {
  if (dom.popTimer) clearTimeout(dom.popTimer);
  dom.scoreEl.classList.add('pop');
  dom.popTimer = setTimeout(() => { dom.scoreEl.classList.remove('pop'); dom.popTimer=null; }, 300);
}

function actO(i) {
  if (state.done) return;
  save(); progressRest();
  const p = state.seats[i];
  if (p.st!=='active') return;
  if (p.rest > 0) { render(); nextQ(); return; }
  p.sc++; p.totalSc++;
  triggerPop(domSeats[i]);
  if (p.stage < conf.kNormas.length && p.sc >= conf.kNormas[p.stage]) {
    p.stage++; p.sc=0;
    if (p.stage===5) { state.gateReachCount++; if (state.gateReachCount%conf.gateTrigger===0) state.dropQuota+=conf.gateDrop; applyDrop(i); }
    if (p.stage >= conf.kNormas.length) { p.st='won'; state.done=true; }
  }
  render(); nextQ();
}

function actX(i) {
  if (state.done) return;
  save(); progressRest();
  const p = state.seats[i];
  if (p.st!=='active') return;
  p.totalWr++;
  triggerPop(domSeats[i]);
  const dom = domSeats[i];
  dom.root.classList.add('animate-shake'); setTimeout(()=>dom.root.classList.remove('animate-shake'),500);
  if (p.stage < 5) { p.wr++; p.sc=0; if (p.wr>=conf.maxX) p.st='lost'; }
  else { p.rest = state.seats.filter(x=>x&&x.st!=='lost').length * conf.restMult; }
  render(); nextQ();
}

function actThru() { if (state.done) return; save(); progressRest(); render(); nextQ(); }

function actVoid() {
  if (state.done) return;
  save(); progressRest();
  const qEl=document.getElementById('q-text'), aEl=document.getElementById('a-text');
  qEl.classList.add('fade-out'); aEl.classList.add('fade-out');
  setTimeout(()=>{ state.qIdx++; state.qNum++; qEl.classList.remove('fade-out'); aEl.classList.remove('fade-out'); render(); },250);
}

function nextQ() {
  const qEl=document.getElementById('q-text'), aEl=document.getElementById('a-text');
  qEl.classList.add('fade-out'); aEl.classList.add('fade-out');
  setTimeout(()=>{ state.qIdx++; state.qNum++; qEl.classList.remove('fade-out'); aEl.classList.remove('fade-out'); render(); },250);
}

function actUndo() {
  if (!state.hist.length) return;
  Object.assign(state, JSON.parse(state.hist.pop()));
  
  render();
}
</script>
</body>
</html>