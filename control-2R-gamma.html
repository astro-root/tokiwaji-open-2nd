<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2R Course γ 入力画面</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; }
h1 { text-align: center; color: #4caf50; margin-bottom: 20px; }
.tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
.tab { padding: 12px 40px; font-size: 16px; font-weight: bold; background: #2a2a2a; color: white; border: 2px solid #555; border-radius: 5px; cursor: pointer; }
.tab.active { background: #2196f3; border-color: #2196f3; }
.question { background: #2a2a2a; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.question input { width: 100px; padding: 10px; font-size: 18px; text-align: center; margin: 0 10px; background: #1a1a1a; color: white; border: 2px solid #555; border-radius: 5px; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }
.card { background: #2a2a2a; border: 2px solid #555; border-radius: 10px; padding: 20px; }
.card.winner { background: #1a2a1a; border-color: #4a6a4a; }
.card.disqualified { opacity: 0.6; }
.name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
.meta { font-size: 14px; color: #aaa; margin-bottom: 15px; }
.score { display: flex; justify-content: space-around; margin: 15px 0; font-size: 24px; font-weight: bold; }
.score-item { text-align: center; }
.label { font-size: 14px; color: #aaa; }
.buttons { display: flex; gap: 10px; margin-top: 15px; }
.btn { flex: 1; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }
.btn:disabled { opacity: 0.3; cursor: not-allowed; }
.btn-ok { background: #4caf50; color: white; }
.btn-ng { background: #f44336; color: white; }
.btn-win { background: #ff9800; color: white; }
.btn-reset { background: #9e9e9e; color: white; }
.badge { padding: 5px 10px; border-radius: 5px; font-size: 14px; font-weight: bold; margin-top: 10px; display: inline-block; }
.badge-win { background: #ff9800; color: white; }
.badge-lose { background: #f44336; color: white; }
</style>
</head>
<body>
<h1>2nd Round Course γ (5 by 5) 入力画面</h1>
<div class="tabs">
  <button class="tab active" onclick="switchGroup(1)">Group 1</button>
  <button class="tab" onclick="switchGroup(2)">Group 2</button>
</div>
<div class="question">
  <h2>問題番号</h2>
  <button class="btn btn-ng" onclick="changeQ(-1)" style="width: 60px;">-</button>
  <input type="number" id="qNum" value="1" min="1" max="30">
  <button class="btn btn-ok" onclick="changeQ(1)" style="width: 60px;">+</button>
  <div style="margin-top: 10px; color: #aaa;">限定問題数: 30問</div>
</div>
<div class="grid" id="grid"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getDatabase, ref, get, set, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

const app = initializeApp({
  apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
  authDomain: "tokiwaji-open-2nd.firebaseapp.com",
  databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tokiwaji-open-2nd",
  storageBucket: "tokiwaji-open-2nd.firebasestorage.app",
  messagingSenderId: "1053108487162",
  appId: "1:1053108487162:web:1cf8f504522b7e95129a43"
});

const db = getDatabase(app);
let currentGroup = 1;
let participants = [];
let scores = {};

window.switchGroup = function(g) {
  currentGroup = g;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  load();
}

window.changeQ = function(d) {
  const input = document.getElementById('qNum');
  const v = parseInt(input.value) + d;
  if (v >= 1 && v <= 30) {
    input.value = v;
    set(ref(db, `2R/γ/group${currentGroup}/questionNumber`), v);
  }
}

async function load() {
  const snap = await get(ref(db, 'participants'));
  if (snap.exists()) {
    participants = Object.entries(snap.val()).map(([id, p]) => ({ id, ...p })).filter(p => p.course === 'γ' && p.group === currentGroup).sort((a, b) => a.rank - b.rank);
  }
  onValue(ref(db, `2R/γ/group${currentGroup}/scores`), snap => { scores = snap.val() || {}; render(); });
  onValue(ref(db, `2R/γ/group${currentGroup}/questionNumber`), snap => { document.getElementById('qNum').value = snap.val() || 1; });
}

function render() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  participants.forEach(p => {
    const s = scores[p.id] || { x: 0, y: 5, product: 0, winOrder: null, disqualified: false };
    const div = document.createElement('div');
    div.className = 'card';
    if (s.winOrder) div.classList.add('winner');
    if (s.disqualified) div.classList.add('disqualified');
    div.innerHTML = `
      <div class="name">${p.name}</div>
      <div class="meta">${p.rank}位 | ${p.school} | ${p.grade}</div>
      <div class="score">
        <div class="score-item"><div class="label">X</div><div>${s.x || 0}</div></div>
        <div class="score-item"><div class="label">Y</div><div>${s.y !== undefined ? s.y : 5}</div></div>
        <div class="score-item"><div class="label">積</div><div>${s.product || 0}</div></div>
      </div>
      <div class="buttons">
        <button class="btn btn-ok" onclick="correct('${p.id}')" ${s.winOrder || s.disqualified ? 'disabled' : ''}>正解 (X+1)</button>
        <button class="btn btn-ng" onclick="wrong('${p.id}')" ${s.winOrder || s.disqualified ? 'disabled' : ''}>誤答 (Y-1)</button>
      </div>
      <div class="buttons">
        <button class="btn btn-win" onclick="win('${p.id}')" ${s.winOrder || s.disqualified ? 'disabled' : ''}>勝ち抜け</button>
        <button class="btn btn-reset" onclick="reset('${p.id}')">リセット</button>
      </div>
      ${s.winOrder ? `<div class="badge badge-win">勝ち抜け ${s.winOrder}位</div>` : ''}
      ${s.disqualified ? `<div class="badge badge-lose">失格</div>` : ''}
    `;
    grid.appendChild(div);
  });
}

window.correct = async function(pid) {
  const s = scores[pid] || { x: 0, y: 5, product: 0 };
  s.x++;
  s.product = s.x * s.y;
  if (s.product >= 25) {
    const winners = Object.values(scores).filter(x => x.winOrder).length;
    s.winOrder = winners + 1;
  }
  await set(ref(db, `2R/γ/group${currentGroup}/scores/${pid}`), s);
}

window.wrong = async function(pid) {
  const s = scores[pid] || { x: 0, y: 5, product: 0 };
  s.y--;
  s.product = s.x * s.y;
  if (s.y <= 2) {
    s.disqualified = true;
  }
  await set(ref(db, `2R/γ/group${currentGroup}/scores/${pid}`), s);
}

window.win = async function(pid) {
  const s = scores[pid] || { x: 0, y: 5, product: 0 };
  const winners = Object.values(scores).filter(x => x.winOrder).length;
  s.winOrder = winners + 1;
  await set(ref(db, `2R/γ/group${currentGroup}/scores/${pid}`), s);
}

window.reset = async function(pid) {
  if (confirm('リセットしますか？')) {
    await set(ref(db, `2R/γ/group${currentGroup}/scores/${pid}`), { x: 0, y: 5, product: 0, winOrder: null, disqualified: false });
  }
}

load();
</script>
</body>
</html>
