<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2R Course α 表示</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #0f172a;
    --card-bg: #1e293b;
    --border-color: #334155;
    --text-color: #f1f5f9;
    --win-color: #ef4444;
    --rest-color: #6366f1;
    --correct-bg: #22c55e;
    --active-tab: #3b82f6;
    --inactive-tab: #1e293b;
}
* { box-sizing: border-box; }
body {
    margin: 0;
    font-family: 'Roboto', 'Noto Sans JP', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
header {
    background: #020617;
    border-bottom: 1px solid var(--border-color);
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 80px;
}
.header-left { display: flex; align-items: center; gap: 20px; }
.logo { height: 50px; width: auto; object-fit: contain; }
.title-group { display: flex; flex-direction: column; }
.main-title { font-size: 1.2rem; font-weight: 900; color: #94a3b8; }
.sub-title { font-size: 1rem; font-weight: 700; color: #64748b; }

.tabs { display: flex; background: #0f172a; padding: 4px; border-radius: 8px; gap: 5px; border: 1px solid var(--border-color); }
.tab-btn {
    background: transparent;
    border: none;
    color: #64748b;
    padding: 8px 24px;
    font-weight: 700;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}
.tab-btn.active { background: var(--active-tab); color: white; }

.header-right { display: flex; gap: 15px; align-items: center; }
.counter-box {
    background: #0f172a;
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: 8px;
    font-family: 'Roboto', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: #cbd5e1;
    min-width: 100px;
    text-align: center;
}

/* Question Area */
.question-area {
    background: #1e293b;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border-color);
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 20px;
    align-items: center;
    min-height: 100px;
}
.q-number {
    font-size: 1.5rem;
    color: #60a5fa;
    font-weight: 900;
    text-align: center;
    border-right: 3px solid var(--border-color);
    padding-right: 20px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.q-content { display: flex; flex-direction: column; gap: 5px; }
.q-text { font-size: 1.4rem; font-weight: 700; line-height: 1.3; }
.a-text { font-size: 1.1rem; color: #fbbf24; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.a-label { font-size: 0.8rem; background: #451a03; color: #fbbf24; padding: 2px 8px; border-radius: 4px; }

/* Players Grid */
main {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}
.players {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* 幅を狭く調整 */
    gap: 15px;
}

/* 縦書きカードスタイル */
.player-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    height: 320px; /* 高さを確保 */
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
}

.player-card.winner { border-color: var(--win-color); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }
.player-card.rest { border-color: var(--rest-color); background: #1e1b4b; opacity: 0.9; }
.player-card.lost { opacity: 0.5; filter: grayscale(1); }

/* ランク表示エリア */
.rank-area {
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Roboto', sans-serif;
    font-weight: 900;
    font-size: 1.5rem;
    color: #fbbf24;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    background: rgba(0,0,0,0.2);
}
.rank-text { color: var(--win-color); }

/* メイン（縦書きエリア） */
.vertical-body {
    flex: 1;
    display: flex;
    flex-direction: row-reverse; /* 右から左へ（氏名→所属） */
    justify-content: center;
    align-items: center;
    padding: 10px;
    gap: 10px;
    writing-mode: vertical-rl; /* 縦書き */
}

.p-name-v {
    font-size: 1.8rem;
    font-weight: 900;
    letter-spacing: 0.1rem;
    color: white;
    /* 長い名前対応 */
    max-height: 100%;
}
.p-school-v {
    font-size: 1rem;
    color: #94a3b8;
    font-weight: 700;
    letter-spacing: 0.05rem;
}

/* スコア表示（下部） */
.score-footer {
    height: 50px;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    border-top: 1px solid rgba(255,255,255,0.05);
}
.score-item {
    font-family: 'Roboto', sans-serif;
    font-size: 1.4rem;
    font-weight: 900;
    display: flex;
    align-items: center;
}
.score-c { color: var(--correct-bg); }
.score-w { color: #ef4444; }

/* 休み表示オーバーレイ */
.rest-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(99, 102, 241, 0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    z-index: 10;
}
.rest-mark {
    font-size: 4rem;
    color: rgba(255,255,255,0.2);
    transform: rotate(-15deg);
    font-weight: 900;
    border: 4px solid rgba(255,255,255,0.2);
    padding: 10px;
    border-radius: 10px;
}

</style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="./常磐路オープン2nd_ロゴ.png" alt="Logo" class="logo" onerror="this.style.display='none'">
        <div class="title-group">
            <div class="main-title">Tokiwaji Open 2nd</div>
            <div class="sub-title">2R Course α</div>
        </div>
    </div>
    
    <div class="tabs">
        <button id="tab-1" class="tab-btn active" onclick="switchGroup(1)">Group 1</button>
        <button id="tab-2" class="tab-btn" onclick="switchGroup(2)">Group 2</button>
    </div>

    <div class="header-right">
        <div class="counter-box" id="survivor-count">Alive: 0</div>
        <div class="counter-box" id="win-slots">Slots: 0</div>
    </div>
</header>

<div class="question-area">
    <div class="q-number" id="qnum">Q.-</div>
    <div class="q-content">
        <div class="q-text" id="qtext">読み込み中...</div>
        <div class="a-text">
            <span class="a-label">ANSWER</span>
            <span id="ans"></span>
        </div>
    </div>
</div>

<main>
    <div id="players" class="players"></div>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js'
import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js'

const firebaseConfig = {
    apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
    authDomain: "tokiwaji-open-2nd.firebaseapp.com",
    databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tokiwaji-open-2nd",
    storageBucket: "tokiwaji-open-2nd.firebasestorage.app",
    messagingSenderId: "1053108487162",
    appId: "1:1053108487162:web:1cf8f504522b7e95129a43"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Global State
let participants = [];
let scores = { 1: {}, 2: {} };
let questions = [];
let questionIndices = { 1: 0, 2: 0 };
let currentGroup = 1;

window.switchGroup = (groupNum) => {
    currentGroup = groupNum;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${groupNum}`).classList.add('active');
    render();
    updateQuestionDisplay();
};

// --- Firebase Listeners ---
onValue(ref(db, 'participants'), snapshot => {
    if(snapshot.exists()) {
        participants = Object.entries(snapshot.val())
            .map(([id, p]) => ({ id, ...p }))
            .filter(p => p.course === 'α');
    } else {
        participants = [];
    }
    render();
});

onValue(ref(db, '2R/α/group1/scores'), s => { scores[1] = s.val() || {}; render(); });
onValue(ref(db, '2R/α/group2/scores'), s => { scores[2] = s.val() || {}; render(); });

onValue(ref(db, '2R/α/questions'), s => {
    if (s.exists()) {
        const val = s.val();
        questions = Array.isArray(val) ? val : Object.values(val);
    } else {
        questions = [];
    }
    updateQuestionDisplay();
});

onValue(ref(db, '2R/α/group1/questionNumber'), s => {
    questionIndices[1] = (s.val() || 1) - 1;
    if(currentGroup === 1) updateQuestionDisplay();
});
onValue(ref(db, '2R/α/group2/questionNumber'), s => {
    questionIndices[2] = (s.val() || 1) - 1;
    if(currentGroup === 2) updateQuestionDisplay();
});

// --- Render Logic ---

function getOrdinal(n) {
    const s = ["th", "st", "nd", "rd"];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function render() {
    const box = document.getElementById('players');
    box.innerHTML = '';
    
    const ps = participants.filter(p => Number(p.group) === currentGroup);

    if (ps.length === 0 && participants.length > 0) {
        box.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#aaa">このグループの参加者は登録されていません</div>';
        updateStats(0, 0);
        return;
    }

    ps.forEach(p => {
        const s = scores[currentGroup][p.id] || { correct: 0, wrong: 0, rest: 0 };
        const isWinner = s.winOrder ? true : false;
        const isRest = (s.rest || 0) > 0;
        const isLost = (s.wrong || 0) >= 2;
        
        const div = document.createElement('div');
        div.className = `player-card ${isWinner ? 'winner' : ''} ${isRest ? 'rest' : ''} ${isLost ? 'lost' : ''}`;
        
        let rankDisplay = '';
        if(isWinner) {
            rankDisplay = `<span class="rank-text">${getOrdinal(s.winOrder)} Win</span>`;
        } else if (isLost) {
            rankDisplay = '<span style="color:#666">LOSE</span>';
        } else if (isRest) {
            rankDisplay = '<span style="color:#6366f1">WAIT</span>';
        }

        div.innerHTML = `
            <div class="rank-area">
                ${rankDisplay}
            </div>
            
            <div class="vertical-body">
                <div class="p-name-v">${p.name}</div>
                <div class="p-school-v">${p.school || ''} ${p.grade || ''}</div>
            </div>

            <div class="score-footer">
                <div class="score-item score-c">${s.correct || 0}○</div>
                <div class="score-item score-w">${s.wrong || 0}×</div>
            </div>

            ${isRest ? `<div class="rest-overlay"><div class="rest-mark">休 ${s.rest}</div></div>` : ''}
        `;
        box.appendChild(div);
    });

    updateStats(ps, scores[currentGroup]);
}

function updateStats(ps, groupScores) {
    if (!ps || !groupScores) return;
    
    const activeCount = ps.filter(p => {
        const s = groupScores[p.id] || {};
        return !s.winOrder && (s.wrong || 0) < 2; 
    }).length;

    const winnerCount = Object.values(groupScores).filter(s => s && s.winOrder).length;
    
    document.getElementById('survivor-count').textContent = `Alive: ${activeCount}`;
    document.getElementById('win-slots').textContent = `Slots: ${Math.max(0, 5 - winnerCount)}`;
}

function updateQuestionDisplay() {
    const idx = questionIndices[currentGroup];
    document.getElementById('qnum').textContent = `Q.${idx + 1}`;
    
    if (questions && questions.length > idx && questions[idx]) {
        const q = questions[idx];
        document.getElementById('qtext').textContent = q.question;
        document.getElementById('ans').textContent = q.answer || '(解答なし)';
    } else {
        document.getElementById('qtext').textContent = '待機中... (問題データなし)';
        document.getElementById('ans').textContent = '';
    }
}
</script>
</body>
</html>
