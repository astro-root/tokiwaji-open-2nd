<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2R Course α 表示</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #0f172a;
    --card-bg: #1e293b;
    --border-color: #334155;
    --text-color: #f1f5f9;
    --win-color: #ef4444;
    --rest-color: #6366f1;
    --correct-bg: #22c55e;
    --active-tab: #3b82f6;
    --inactive-tab: #1e293b;
}
* { box-sizing: border-box; }
body {
    margin: 0;
    font-family: 'Roboto', 'Noto Sans JP', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
header {
    background: #020617;
    border-bottom: 1px solid var(--border-color);
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 80px;
}
.header-left { display: flex; align-items: center; gap: 20px; }
.logo { height: 50px; width: auto; object-fit: contain; }
.title-group { display: flex; flex-direction: column; }
.main-title { font-size: 1.2rem; font-weight: 900; color: #94a3b8; }
.sub-title { font-size: 1rem; font-weight: 700; color: #64748b; }

.tabs { display: flex; background: #0f172a; padding: 4px; border-radius: 8px; gap: 5px; border: 1px solid var(--border-color); }
.tab-btn {
    background: transparent;
    border: none;
    color: #64748b;
    padding: 8px 24px;
    font-weight: 700;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}
.tab-btn.active { background: var(--active-tab); color: white; }

.header-right { display: flex; gap: 15px; align-items: center; }
.counter-box {
    background: #0f172a;
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: 8px;
    font-family: 'Roboto', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: #cbd5e1;
    min-width: 100px;
    text-align: center;
}

/* Question Area */
.question-area {
    background: #1e293b;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-color);
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 20px;
    align-items: center;
    min-height: 120px;
}
.q-number {
    font-size: 1.5rem;
    color: #60a5fa;
    font-weight: 900;
    text-align: center;
    border-right: 3px solid var(--border-color);
    padding-right: 20px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.q-content { display: flex; flex-direction: column; gap: 8px; }
.q-text { font-size: 1.6rem; font-weight: 700; line-height: 1.3; }
.a-text { font-size: 1.2rem; color: #fbbf24; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.a-label { font-size: 0.9rem; background: #451a03; color: #fbbf24; padding: 2px 8px; border-radius: 4px; }

/* Players Grid */
main {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}
.players {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}
.player-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    height: 260px;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
}
.player-card.winner { border-color: var(--win-color); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }
.player-card.rest { border-color: var(--rest-color); background: #1e1b4b; opacity: 0.9; }

.p-header {
    padding: 8px 12px;
    background: rgba(0,0,0,0.3);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.p-name { font-size: 1.1rem; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.p-meta { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }

.p-body {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}
.p-vertical-name {
    writing-mode: vertical-rl;
    text-orientation: upright;
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: 0.2rem;
    color: rgba(255,255,255,0.05);
    position: absolute;
    height: 100%;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    user-select: none;
}
.p-score-display {
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 5px;
    align-items: center;
}
.score-row {
    display: flex;
    gap: 15px;
    font-size: 2rem;
    font-weight: 900;
    font-family: 'Roboto', sans-serif;
}
.score-c { color: var(--correct-bg); text-shadow: 0 0 15px rgba(34, 197, 94, 0.2); }
.score-w { color: #ef4444; }

.p-footer {
    padding: 8px;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    min-height: 36px;
}
.rest-badge { color: #a5b4fc; font-size: 0.9rem; }
.win-badge { background: var(--win-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; }
</style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="./常磐路オープン2nd_ロゴ.png" alt="Logo" class="logo" onerror="this.style.display='none'">
        <div class="title-group">
            <div class="main-title">Tokiwaji Open 2nd</div>
            <div class="sub-title">2R Course α</div>
        </div>
    </div>
    
    <div class="tabs">
        <button id="tab-1" class="tab-btn active" onclick="switchGroup(1)">Group 1</button>
        <button id="tab-2" class="tab-btn" onclick="switchGroup(2)">Group 2</button>
    </div>

    <div class="header-right">
        <div class="counter-box" id="survivor-count">Alive: 0</div>
        <div class="counter-box" id="win-slots">Slots: 0</div>
    </div>
</header>

<div class="question-area">
    <div class="q-number" id="qnum">Q.-</div>
    <div class="q-content">
        <div class="q-text" id="qtext">読み込み中...</div>
        <div class="a-text">
            <span class="a-label">ANSWER</span>
            <span id="ans"></span>
        </div>
    </div>
</div>

<main>
    <div id="players" class="players"></div>
</main>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js'
import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js'

const firebaseConfig = {
    apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
    authDomain: "tokiwaji-open-2nd.firebaseapp.com",
    databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tokiwaji-open-2nd",
    storageBucket: "tokiwaji-open-2nd.firebasestorage.app",
    messagingSenderId: "1053108487162",
    appId: "1:1053108487162:web:1cf8f504522b7e95129a43"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Global State
let participants = [];
let scores = { 1: {}, 2: {} };
let questions = [];
let questionIndices = { 1: 0, 2: 0 }; // 各グループの現在の問題番号
let currentGroup = 1;

// グローバル関数として登録（HTMLから呼べるように）
window.switchGroup = (groupNum) => {
    currentGroup = groupNum;
    
    // タブの見た目更新
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${groupNum}`).classList.add('active');
    
    // 再描画
    render();
    updateQuestionDisplay();
};

// --- Firebase Listeners ---

// 1. 参加者データ
onValue(ref(db, 'participants'), snapshot => {
    if(snapshot.exists()) {
        participants = Object.entries(snapshot.val())
            .map(([id, p]) => ({ id, ...p }))
            .filter(p => p.course === 'α');
    } else {
        participants = [];
    }
    render();
});

// 2. スコアデータ (Group 1 & 2)
onValue(ref(db, '2R/α/group1/scores'), s => { scores[1] = s.val() || {}; render(); });
onValue(ref(db, '2R/α/group2/scores'), s => { scores[2] = s.val() || {}; render(); });

// 3. 問題データ
onValue(ref(db, '2R/α/questions'), s => {
    if (s.exists()) {
        const val = s.val();
        questions = Array.isArray(val) ? val : Object.values(val);
    } else {
        questions = [];
    }
    updateQuestionDisplay();
});

// 4. 現在の問題番号 (Group 1 & 2)
onValue(ref(db, '2R/α/group1/questionNumber'), s => {
    questionIndices[1] = (s.val() || 1) - 1;
    if(currentGroup === 1) updateQuestionDisplay();
});
onValue(ref(db, '2R/α/group2/questionNumber'), s => {
    questionIndices[2] = (s.val() || 1) - 1;
    if(currentGroup === 2) updateQuestionDisplay();
});

// --- Render Logic ---

function render() {
    const box = document.getElementById('players');
    box.innerHTML = '';
    
    // 現在のグループの参加者を抽出
    const ps = participants.filter(p => Number(p.group) === currentGroup);

    if (ps.length === 0 && participants.length > 0) {
        box.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#aaa">このグループの参加者は登録されていません</div>';
        updateStats(0, 0);
        return;
    }

    ps.forEach(p => {
        const s = scores[currentGroup][p.id] || { correct: 0, wrong: 0, rest: 0 };
        const isWinner = s.winOrder ? true : false;
        const isRest = (s.rest || 0) > 0;
        
        const div = document.createElement('div');
        div.className = `player-card ${isWinner ? 'winner' : ''} ${isRest ? 'rest' : ''}`;
        
        div.innerHTML = `
            <div class="p-header">
                <div class="p-name">${p.name}</div>
                <div class="p-meta">${p.school || ''} ${p.grade || ''}</div>
            </div>
            <div class="p-body">
                <div class="p-vertical-name">${p.name}</div>
                <div class="p-score-display">
                    <div class="score-row">
                        <span class="score-c">${s.correct || 0}○</span>
                        <span class="score-w">${s.wrong || 0}×</span>
                    </div>
                </div>
            </div>
            <div class="p-footer">
                <div class="rest-badge">${isRest ? '休: ' + '⛄'.repeat(s.rest) : ''}</div>
                ${isWinner ? `<div class="win-badge">WIN #${s.winOrder}</div>` : ''}
            </div>
        `;
        box.appendChild(div);
    });

    updateStats(ps, scores[currentGroup]);
}

function updateStats(ps, groupScores) {
    if (!ps || !groupScores) return;
    
    // 生存者: 勝ち抜けておらず、失格(2x)もしていない
    const activeCount = ps.filter(p => {
        const s = groupScores[p.id] || {};
        return !s.winOrder && (s.wrong || 0) < 2; 
    }).length;

    const winnerCount = Object.values(groupScores).filter(s => s && s.winOrder).length;
    
    document.getElementById('survivor-count').textContent = `Alive: ${activeCount}`;
    document.getElementById('win-slots').textContent = `Slots: ${Math.max(0, 5 - winnerCount)}`;
}

function updateQuestionDisplay() {
    // 現在のグループの問題番号を取得
    const idx = questionIndices[currentGroup];
    
    document.getElementById('qnum').textContent = `Q.${idx + 1}`;
    
    if (questions && questions.length > idx && questions[idx]) {
        const q = questions[idx];
        document.getElementById('qtext').textContent = q.question;
        document.getElementById('ans').textContent = q.answer || '(解答なし)';
    } else {
        document.getElementById('qtext').textContent = '待機中... (問題データなし)';
        document.getElementById('ans').textContent = '';
    }
}
</script>
</body>
</html>
