<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2R Course α 管理</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #1a1a1a;
    --panel-bg: #262626;
    --border-color: #404040;
    --text-color: #e5e5e5;
    --primary: #3b82f6;
    --danger: #ef4444;
    --success: #22c55e;
    --active-tab: #2563eb;
    --inactive-tab: #404040;
}
body {
    margin: 0;
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    padding: 20px;
}

/* Header & Tabs */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}
h1 { margin: 0; font-size: 1.5rem; border-left: 5px solid var(--primary); padding-left: 15px; }

.tabs { display: flex; gap: 5px; }
.tab-btn {
    padding: 8px 20px;
    border: none;
    background: var(--inactive-tab);
    color: #aaa;
    font-weight: 700;
    cursor: pointer;
    border-radius: 6px 6px 0 0;
    transition: all 0.2s;
}
.tab-btn.active {
    background: var(--active-tab);
    color: white;
    transform: translateY(2px);
}

/* Layout */
.grid-container {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 20px;
    align-items: start;
}
@media(max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }

section {
    background: var(--panel-bg);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
}
h2 { font-size: 1rem; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: #a3a3a3; display: flex; justify-content: space-between; }

/* Controls */
.control-group { margin-bottom: 15px; }
.btn {
    cursor: pointer;
    padding: 10px 16px;
    border-radius: 6px;
    border: none;
    font-weight: 700;
    color: white;
    transition: opacity 0.2s;
    font-size: 0.9rem;
}
.btn:hover { opacity: 0.8; }
.btn-primary { background: var(--primary); }
.btn-danger { background: var(--danger); }
.btn-success { background: var(--success); }
.btn-neutral { background: #525252; }

input[type="file"] { width: 100%; font-size: 0.9rem; }
input[type="number"] {
    width: 100%;
    padding: 8px;
    background: #171717;
    color: white;
    border: 1px solid #555;
    border-radius: 4px;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

/* Question Control */
.q-control-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
.q-control-row .btn { flex: 1; }
.q-display {
    background: #000;
    padding: 15px;
    border-radius: 4px;
    font-size: 0.9rem;
    min-height: 80px;
    margin-bottom: 10px;
    border: 1px solid #333;
}
.q-ans-display { color: #fbbf24; font-weight: bold; margin-top: 8px; font-size: 1.1rem; border-top: 1px dashed #333; padding-top: 5px; }
.hidden-q { color: #555; font-style: italic; text-align: center; padding: 20px; }

/* Rules Control */
.rules-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.rules-grid label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 4px; }

/* Player List */
.player-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 12px;
}
.player-card {
    background: #171717;
    border: 1px solid var(--border-color);
    padding: 12px;
    border-radius: 6px;
    position: relative;
}
.player-card.resting { border-color: #6366f1; }
.player-card.winner { border-color: #22c55e; }

.player-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 1.1rem; }
.player-stats { font-size: 0.9rem; color: #a3a3a3; margin-bottom: 12px; display: flex; gap: 10px; }
.stat-box { background: #333; padding: 2px 8px; border-radius: 4px; }

.player-actions { display: grid; grid-template-columns: 1fr 1fr 60px; gap: 8px; }
.player-actions button { padding: 8px 0; font-size: 0.9rem; }

/* Status Indicator */
.status-indicator {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-left: 10px;
}
.bg-green { background: #064e3b; color: #6ee7b7; }
.bg-blue { background: #1e3a8a; color: #93c5fd; }
</style>
</head>
<body>

<header>
    <h1>2R α : Management</h1>
    <div class="tabs">
        <button id="tab-1" class="tab-btn active" onclick="window.switchGroup(1)">Group 1</button>
        <button id="tab-2" class="tab-btn" onclick="window.switchGroup(2)">Group 2</button>
    </div>
</header>

<div class="grid-container">
    
    <div class="left-col">
        <section>
            <h2>
                <span>操作パネル</span>
                <span id="current-group-label" class="status-indicator bg-blue">Group 1</span>
            </h2>
            
            <div class="q-display">
                <div id="current-q-text" style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">Q. -</div>
                <div id="q-content-area">
                    <div id="current-q-detail" style="color:#aaa; font-size:0.9rem;"></div>
                    <div id="current-q-ans" class="q-ans-display">A: </div>
                </div>
            </div>

            <div class="control-group">
                <label style="display:block; margin-bottom:5px; font-size:0.8rem; color:#aaa;">問題番号 (自動で進みます)</label>
                <div class="q-control-row">
                    <button id="prev" class="btn btn-neutral">&lt;</button>
                    <input type="number" id="q-input" min="1" value="1">
                    <button id="next" class="btn btn-primary">&gt;</button>
                </div>
            </div>

            <div class="control-group">
                <button id="skip" class="btn btn-neutral" style="width:100%">スルー (次へ & 休み減算)</button>
            </div>
        </section>

        <section>
            <h2>ルール・表示設定 (全体共有)</h2>
            <div class="rules-grid">
                <div>
                    <label>勝ち抜けポイント</label>
                    <input type="number" id="win-points-input" value="5">
                </div>
                <div>
                    <label>Slots (勝ち抜け枠)</label>
                    <input type="number" id="max-slots-input" value="5">
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size:0.8rem;color:#aaa;">誤答ペナルティ (現在の問題番号)</label>
                <input type="number" id="rest-penalty-input" value="1">
            </div>
        </section>

        <section>
            <h2>システム設定</h2>
            <div class="control-group">
                <label style="display:block; margin-bottom:5px; font-size:0.9rem;">問題CSV読み込み</label>
                <input type="file" id="csv" accept=".csv">
            </div>
            <div class="control-group">
                <button id="reset-all" class="btn btn-danger" style="width:100%">このグループをリセット</button>
            </div>
        </section>
    </div>

    <div class="right-col">
        <section>
            <h2>参加者一覧</h2>
            <div id="players" class="player-list"></div>
        </section>
    </div>

</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js'
import { getDatabase, ref, onValue, set, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js'

const firebaseConfig = {
    apiKey: "AIzaSyDB_EIa1D49jxMrNVkqJjSrghh6Yp-MLP0",
    authDomain: "tokiwaji-open-2nd.firebaseapp.com",
    databaseURL: "https://tokiwaji-open-2nd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tokiwaji-open-2nd",
    storageBucket: "tokiwaji-open-2nd.firebasestorage.app",
    messagingSenderId: "1053108487162",
    appId: "1:1053108487162:web:1cf8f504522b7e95129a43"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Global State
let participants = [];
let scores = { 1: {}, 2: {} };
let questions = [];
let questionIndices = { 1: 1, 2: 1 }; 
let currentGroup = 1;
let lastAction = null; 
let config = { winPoint: 5, maxSlots: 5 };

// --- Global Functions ---
window.switchGroup = (g) => {
    currentGroup = g;
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${g}`).classList.add('active');
    
    const lbl = document.getElementById('current-group-label');
    lbl.textContent = `Group ${g}`;
    lbl.className = g === 1 ? 'status-indicator bg-blue' : 'status-indicator bg-green';

    const input = document.getElementById('q-input');
    if(input) input.value = questionIndices[g];
    
    document.getElementById('rest-penalty-input').value = questionIndices[g];

    updateCurrentQuestionDisplay();
    renderPlayers();
};

// --- Data Sync ---
onValue(ref(db, 'participants'), s => {
    participants = s.exists() ? Object.entries(s.val()).map(([id, p]) => ({ id, ...p })).filter(p => p.course === 'α') : [];
    renderPlayers();
});

onValue(ref(db, '2R/α/group1/scores'), s => { scores[1] = s.val() || {}; if(currentGroup===1) renderPlayers(); });
onValue(ref(db, '2R/α/group2/scores'), s => { scores[2] = s.val() || {}; if(currentGroup===2) renderPlayers(); });

onValue(ref(db, '2R/α/questions'), s => {
    if (s.exists()) {
        const val = s.val();
        questions = Array.isArray(val) ? val : Object.values(val);
    } else {
        questions = [];
    }
    updateCurrentQuestionDisplay();
});

onValue(ref(db, '2R/α/group1/questionNumber'), s => {
    questionIndices[1] = s.val() || 1;
    if(currentGroup === 1) {
        document.getElementById('q-input').value = questionIndices[1];
        document.getElementById('rest-penalty-input').value = questionIndices[1];
        updateCurrentQuestionDisplay();
    }
});
onValue(ref(db, '2R/α/group2/questionNumber'), s => {
    questionIndices[2] = s.val() || 1;
    if(currentGroup === 2) {
        document.getElementById('q-input').value = questionIndices[2];
        document.getElementById('rest-penalty-input').value = questionIndices[2];
        updateCurrentQuestionDisplay();
    }
});

// 設定の同期
onValue(ref(db, '2R/α/config'), s => {
    if(s.exists()) {
        config = s.val();
        document.getElementById('win-points-input').value = config.winPoint || 5;
        document.getElementById('max-slots-input').value = config.maxSlots || 5;
    }
});

// --- Event Listeners ---

// 設定変更時
document.getElementById('win-points-input').onchange = (e) => update(ref(db, '2R/α/config'), { winPoint: Number(e.target.value) });
document.getElementById('max-slots-input').onchange = (e) => update(ref(db, '2R/α/config'), { maxSlots: Number(e.target.value) });

document.getElementById('csv').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
        const lines = r.result.split(/\r?\n/).filter(l => l.trim());
        const qs = lines.map(l => {
            const c = l.split(',');
            return { question: c[0], answer: c.slice(1).join(',') };
        });
        set(ref(db, '2R/α/questions'), qs);
        alert(`${qs.length}問 読み込み完了`);
    };
    r.readAsText(f, 'utf-8');
});

const setQ = (num) => {
    const n = Math.max(1, parseInt(num, 10) || 1);
    set(ref(db, `2R/α/group${currentGroup}/questionNumber`), n);
};

document.getElementById('prev').onclick = () => setQ(questionIndices[currentGroup] - 1);
document.getElementById('next').onclick = () => setQ(questionIndices[currentGroup] + 1);
document.getElementById('q-input').onchange = (e) => setQ(e.target.value);

document.getElementById('reset-all').onclick = () => {
    if(confirm(`[Group ${currentGroup}] を本当にリセットしますか？\n全員のスコアが0になり、問題番号が1に戻ります。`)) {
        set(ref(db, `2R/α/group${currentGroup}/scores`), {});
        set(ref(db, `2R/α/group${currentGroup}/questionNumber`), 1);
    }
};

// スルーボタン：休み減算して次の問題へ
document.getElementById('skip').onclick = () => {
    const ps = participants.filter(p => Number(p.group) === currentGroup);
    let updates = {};
    ps.forEach(p => {
        const s = scores[currentGroup][p.id];
        if (s && s.rest > 0) {
            updates[`scores/${p.id}/rest`] = s.rest - 1;
        }
    });
    
    if(Object.keys(updates).length > 0) {
        update(ref(db, `2R/α/group${currentGroup}`), updates);
    }
    // 自動で次へ
    setQ(questionIndices[currentGroup] + 1);
};

// --- Rendering & Logic ---

function updateCurrentQuestionDisplay() {
    const idx = questionIndices[currentGroup] - 1;
    const q = questions[idx];
    const area = document.getElementById('q-content-area');

    document.getElementById('current-q-text').textContent = `Q${idx + 1}`;

    // 1問目は隠す処理
    if (idx === 0) {
        area.innerHTML = `
            <div class="hidden-q">ここに問題が表示されます</div>
            <div class="hidden-q" style="border-top:1px dashed #333;margin-top:0;">ここに解答が表示されます</div>
        `;
    } else {
        area.innerHTML = `
            <div id="current-q-detail" style="color:#aaa; font-size:0.9rem;">${q ? q.question : '(問題未登録)'}</div>
            <div id="current-q-ans" class="q-ans-display">A: ${q ? q.answer : ''}</div>
        `;
    }
}

function renderPlayers() {
    const box = document.getElementById('players');
    box.innerHTML = '';
    
    const groupParticipants = participants.filter(p => Number(p.group) === currentGroup);
    
    if (groupParticipants.length === 0) {
        box.innerHTML = '<div style="padding:10px;color:#666">このグループの参加者は表示されません</div>';
        return;
    }

    groupParticipants.forEach(p => {
        const s = scores[currentGroup][p.id] || { correct: 0, wrong: 0, rest: 0 };
        const d = document.createElement('div');
        
        const isResting = (s.rest || 0) > 0;
        const isWinner = s.winOrder ? true : false;
        const isDQ = (s.wrong || 0) >= 2;

        d.className = `player-card ${isResting ? 'resting' : ''} ${isWinner ? 'winner' : ''}`;
        
        d.innerHTML = `
            <div class="player-info">
                <span>${p.name}</span>
                <span style="color:${isWinner ? '#22c55e' : (isResting ? '#818cf8' : '#fff')}">
                    ${isWinner ? 'WIN' : (isResting ? `休${s.rest}` : (isDQ ? 'LOSE' : ''))}
                </span>
            </div>
            <div class="player-stats">
                <span class="stat-box" style="color:#4ade80">○ ${s.correct || 0}</span>
                <span class="stat-box" style="color:#f87171">× ${s.wrong || 0}</span>
            </div>
            <div class="player-actions">
                <button class="btn btn-success" data-act="c" ${isWinner||isDQ||isResting?'disabled':''}>正解</button>
                <button class="btn btn-danger" data-act="w" ${isWinner||isDQ||isResting?'disabled':''}>誤答</button>
                <button class="btn btn-neutral" data-act="u">戻</button>
            </div>
        `;
        
        if(isWinner || isDQ || isResting) {
            d.querySelectorAll('button:not([data-act="u"])').forEach(b => b.style.opacity = 0.3);
        }

        d.querySelector('[data-act=c]').onclick = () => {
            if(isWinner || isDQ || isResting) return;
            
            const winPoint = config.winPoint || 5;

            lastAction = { id: p.id, type: 'c', group: currentGroup };
            const newCorrect = (s.correct || 0) + 1;
            
            let updates = {};
            const path = `2R/α/group${currentGroup}`;
            updates[`scores/${p.id}/correct`] = newCorrect;
            
            // Win condition
            if(newCorrect >= winPoint && !s.winOrder) {
                const currentWinners = Object.values(scores[currentGroup]).filter(v => v.winOrder).length;
                updates[`scores/${p.id}/winOrder`] = currentWinners + 1;
            }

            // Reduce others' rest
            groupParticipants.forEach(o => {
                if (o.id !== p.id) {
                    const so = scores[currentGroup][o.id];
                    if (so && so.rest > 0) {
                        updates[`scores/${o.id}/rest`] = so.rest - 1;
                    }
                }
            });

            update(ref(db, path), updates).then(() => {
                // 自動で次の問題へ
                setQ(questionIndices[currentGroup] + 1);
            });
        };

        d.querySelector('[data-act=w]').onclick = () => {
            if(isWinner || isDQ || isResting) return;

            const restCount = parseInt(document.getElementById('rest-penalty-input').value) || 1;

            lastAction = { id: p.id, type: 'w', group: currentGroup };
            
            let updates = {};
            updates[`scores/${p.id}/wrong`] = (s.wrong || 0) + 1;
            updates[`scores/${p.id}/rest`] = restCount;

            // Reduce others' rest
            groupParticipants.forEach(o => {
                if (o.id !== p.id) {
                    const so = scores[currentGroup][o.id];
                    if (so && so.rest > 0) {
                        updates[`scores/${o.id}/rest`] = so.rest - 1;
                    }
                }
            });
            
            update(ref(db, `2R/α/group${currentGroup}`), updates).then(() => {
                // 自動で次の問題へ
                setQ(questionIndices[currentGroup] + 1);
            });
        };

        d.querySelector('[data-act=u]').onclick = () => {
            if (!lastAction || lastAction.id !== p.id || lastAction.group !== currentGroup) {
                alert('直前の操作のみ取り消せます（または対象・グループが違います）');
                return;
            }
            const path = `2R/α/group${currentGroup}/scores/${p.id}`;
            
            if (lastAction.type === 'c') {
                update(ref(db, path), { 
                    correct: Math.max(0, (s.correct || 0) - 1),
                    winOrder: null
                });
            }
            if (lastAction.type === 'w') {
                update(ref(db, path), { 
                    wrong: Math.max(0, (s.wrong || 0) - 1),
                    rest: 0 
                });
            }
            lastAction = null;
        };

        box.appendChild(d);
    });
}
</script>
</body>
</html>
