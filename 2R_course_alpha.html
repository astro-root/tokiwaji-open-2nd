<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>常磐路オープン2nd - 2R(Course α)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Oswald:wght@500;700&family=Roboto+Condensed:wght@700&display=swap');
    :root {
      --bg-main: #0f172a;
      --bg-panel: #1e293b;
      --bg-header: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --accent-blue: #3b82f6;
      --accent-gold: #f59e0b;
      --accent-red: #ef4444;
      --accent-green: #22c55e;
      --border-color: #334155;
      --font-jp: 'Noto Sans JP', sans-serif;
      --font-num: 'Oswald', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
    html, body { height: 100%; overflow: hidden; background-color: var(--bg-main); color: var(--text-primary); font-family: var(--font-jp); }
    body { display: flex; flex-direction: column; background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.1), transparent 40%), radial-gradient(circle at bottom left, rgba(245, 158, 11, 0.05), transparent 40%); }
    header { height: 60px; flex-shrink: 0; display: flex; align-items: center; background-color: var(--bg-header); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,.2), 0 2px 4px -2px rgba(0,0,0,.1); z-index: 20; padding: 0 2rem; background: linear-gradient(to right, var(--bg-header), #24344d); }
    .h-left { display: flex; flex-direction: column; width: 220px; }
    .h-round { font-size: 1rem; color: var(--accent-blue); font-weight: 700; letter-spacing: .05em; text-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
    .h-rule { font-family: var(--font-num); font-size: 3rem; font-weight: 700; line-height: 1; margin-top: 2px; text-align: center; }
    .h-center { flex: 1; display: flex; justify-content: center; align-items: center; }
    .group-badge { background: var(--bg-main); border: 1px solid var(--border-color); padding: .25rem 1rem; font-size: .95rem; font-weight: 700; border-radius: 4px; letter-spacing: .1em; color: var(--text-primary); box-shadow: inset 0 2px 4px 0 rgba(0,0,0,.2); }
    .h-right { display: flex; align-items: center; gap: 1.5rem; width: auto; justify-content: flex-end; min-width: 250px; }
    .q-badge { background: linear-gradient(135deg, var(--accent-blue), #2563eb); color: white; padding: 0 1rem; height: 56px; min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; }
    .q-lbl { font-size: .6rem; font-weight: 700; opacity: .9; }
    .q-val { font-family: var(--font-num); font-size: 2.2rem; font-weight: 700; line-height: .9; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .q-val.pop { transform: scale(1.3); }
    .logo-img { height: 50px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,.3)); margin-left: 10px; transition: transform 0.3s ease; }
    .logo-img:hover { transform: rotate(-5deg) scale(1.05); }
    #question-area { height: 180px; flex-shrink: 0; background: linear-gradient(to bottom, #1f2937, #111827); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; padding: 1rem 3rem; position: relative; align-items: flex-start; box-shadow: inset 0 -4px 6px -1px rgba(0,0,0,.1); }
    .q-ctrls { position: absolute; bottom: .8rem; right: 1rem; display: flex; gap: .5rem; z-index: 10; opacity: .4; transition: opacity .2s; }
    .q-ctrls:hover { opacity: 1; }
    .sys-btn { background: rgba(255,255,255,.05); border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: .3rem .6rem; font-size: .7rem; font-weight: 700; border-radius: 4px; cursor: pointer; transition: all .15s ease; }
    .sys-btn:hover { background: var(--text-secondary); color: var(--bg-main); transform: translateY(-1px); }
    .sys-btn:active { transform: translateY(1px); }
    #q-text { font-size: clamp(20px, 2.6vw, 34px); font-weight: 700; text-align: left; line-height: 1.15; height: calc(1.15em * 3); overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; align-items: center; justify-content: flex-start; color: #fff; width: 100%; transition: opacity 0.2s, transform 0.2s; }
    #q-text.fade-out { opacity: 0; transform: translateY(-5px); }
    .ph-q { color: var(--text-secondary) !important; font-style: italic; font-weight: 500 !important; }
    .a-container { display: flex; align-items: baseline; gap: 1rem; margin-top: .5rem; width: 100%; }
    .a-label { font-family: var(--font-num); font-size: 1.2rem; color: var(--accent-blue); font-weight: 700; letter-spacing: .1em; }
    #a-text { font-size: clamp(16px, 2.2vw, 26px); font-weight: 700; text-align: left; color: var(--accent-gold); line-height: 1.1; flex: 1; height: calc(1.1em * 2); overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; transition: opacity 0.2s 0.1s, transform 0.2s 0.1s; text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
    #a-text.fade-out { opacity: 0; transform: translateY(5px); }
    .ph-a { color: rgba(255,255,255,.1); font-size: 1.5rem !important; font-weight: 500 !important; text-shadow: none !important; }
    #main-content { flex: 1; display: flex; flex-direction: column; padding: 1.5rem; background: #0f172a; overflow: hidden; background-image: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
    #players-container { flex: 1; display: flex; gap: 1rem; width: 100%; height: 100%; }
    .p-card { flex: 1; display: flex; flex-direction: column; background: var(--bg-panel); border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 10px 15px -3px rgba(0,0,0,.3), 0 4px 6px -2px rgba(0,0,0,.1); border: 1px solid var(--border-color); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .p-card:not(.slot-empty):hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,.3), 0 10px 10px -5px rgba(0,0,0,.1); border-color: var(--accent-blue); }
    .p-card.slot-empty { background: transparent; border: 2px dashed #334155; opacity: .5; box-shadow: none; }
    .p-card.is-win { border: 2px solid var(--accent-gold); transform: translateY(-8px) scale(1.02) !important; box-shadow: 0 20px 25px -5px rgba(245,158,11,.3), 0 0 20px rgba(245,158,11,0.2); z-index: 5; }
    .p-card.is-win::before { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(to right, transparent, rgba(245, 158, 11, 0.2), transparent); transform: skewX(-25deg); animation: shimmer 2s infinite linear; pointer-events: none; }
    .pc-head { height: 80px; flex-shrink: 0; background: rgba(0,0,0,.2); border-bottom: 1px solid rgba(255,255,255,.05); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; }
    .pc-rank { font-size: 1.1rem; font-weight: 700; color: #fff; padding: 2px 10px; border-radius: 20px; margin-bottom: 4px; box-shadow: 0 2px 4px rgba(0,0,0,.2); }
    .pc-meta { width: 100%; text-align: center; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pc-meta div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pc-body { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: linear-gradient(to bottom, var(--bg-panel), #24344d); }
    .pc-tower { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 0.1)); transition: height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.5s; z-index: 1; height: 0%; }
    .pc-name { writing-mode: vertical-rl; text-orientation: upright; font-weight: 700; letter-spacing: 0; color: var(--text-primary); white-space: nowrap; width: 80px; min-height: 140px; max-height: 200px; display: flex; align-items: center; justify-content: center; font-size: 3.8rem; padding: 0; margin: 0; line-height: 1; text-shadow: 2px 2px 4px rgba(0,0,0,.3); position: relative; z-index: 3; }
    .pc-overlay-win, .pc-overlay-lose, .pc-overlay-rest { position: absolute; inset: 0; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 0.3s ease, backdrop-filter 0.3s ease; }
    .p-card.state-win .pc-overlay-win { opacity: 1; }
    .p-card.state-lost .pc-overlay-lose { opacity: 1; background: rgba(15,23,42,.6); }
    .p-card.state-rest .pc-overlay-rest { opacity: 1; pointer-events: auto; }
    .pc-overlay-rest { z-index: 8; background: rgba(15,23,42,.85); backdrop-filter: blur(0px); }
    .p-card.state-rest .pc-overlay-rest { backdrop-filter: blur(4px); }
    .pc-overlay-rest .rest-inner { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; pointer-events: none; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .p-card.state-rest .rest-inner { transform: scale(1); }
    .rest-num { font-family: var(--font-num); font-size: 5rem; font-weight: 700; color: var(--text-primary); line-height: 1; display: flex; align-items: center; justify-content: center; text-shadow: 0 4px 8px rgba(0,0,0,.5); }
    .rest-lbl { font-size: .9rem; letter-spacing: .1em; color: var(--text-secondary); font-weight: 700; margin-top: .25rem; }
    .pc-status { height: 100px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,.2); border-top: 1px solid rgba(255,255,255,.05); }
    .pc-score { font-family: var(--font-num); font-size: 2.5rem; font-weight: 700; line-height: 1; color: var(--text-primary); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 2px 2px 0px rgba(0,0,0,.2); }
    .pc-score.pop { transform: scale(1.4); color: var(--accent-blue); }
    .pc-score.won { color: var(--accent-gold); font-size: 2.2rem; text-shadow: 0 0 15px rgba(245,158,11,.5); }
    .pc-wrongs { display: flex; gap: 6px; margin-top: 8px; height: 12px; align-items: center; }
    .w-dot { width: 12px; height: 12px; background: #334155; border-radius: 50%; box-shadow: inset 0 1px 3px rgba(0,0,0,.3); transition: all 0.3s ease; }
    .w-dot.on { background: linear-gradient(135deg, var(--accent-red), #dc2626); box-shadow: 0 0 8px var(--accent-red); }
    .w-dot.on.pop-in { animation: dotPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .pc-actions { height: 64px; flex-shrink: 0; display: flex; }
    .btn-act { flex: 1; border: none; cursor: pointer; font-size: 1.5rem; font-weight: 900; color: white; transition: all 0.15s ease; position: relative; overflow: hidden; }
    .btn-act::after { content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(255,255,255,.3); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%); transform-origin: 50% 50%; }
    .btn-act:active::after { animation: ripple 0.4s ease-out; }
    .btn-act:disabled { opacity: .4; cursor: default; filter: grayscale(1); }
    .btn-act:not(:disabled):active { transform: scale(0.95); }
    .btn-o { background: linear-gradient(to bottom, #059669, #047857); }
    .btn-o:not(:disabled):hover { background: linear-gradient(to bottom, #10b981, #059669); }
    .btn-x { background: linear-gradient(to bottom, #991b1b, #7f1d1d); }
    .btn-x:not(:disabled):hover { background: linear-gradient(to bottom, #ef4444, #991b1b); }
    #setup-screen { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; transition: opacity 0.5s ease; }
    .setup-box { width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; background: var(--bg-panel); border: 1px solid var(--border-color); padding: 2rem; border-radius: 12px; color: var(--text-primary); box-shadow: 0 25px 50px -12px rgba(0,0,0,.5); animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
    .setup-box h2 { margin-bottom: 1.5rem; font-family: var(--font-num); border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
    .s-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .s-grp { flex: 1; min-width: 140px; display: flex; flex-direction: column; gap: 4px; }
    .s-grp label { font-size: .75rem; color: var(--text-secondary); font-weight: 700; }
    .s-grp input { width: 100%; background: #0f172a; border: 1px solid var(--border-color); color: #fff; padding: .6rem; font-size: 1rem; font-family: var(--font-num); outline: none; border-radius: 4px; transition: border-color 0.2s, box-shadow 0.2s; }
    .s-grp input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    .btn-start { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--accent-blue), #2563eb); border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; font-family: var(--font-jp); margin-top: 1rem; border-radius: 6px; color: white; transition: all 0.3s ease; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5); }
    .btn-start:active { transform: translateY(0); }
    #player-list { max-height: 400px; overflow-y: auto; background: #0f172a; border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; margin-top: .5rem; display: none; }
    .player-item { display: flex; gap: 1rem; margin-bottom: .5rem; align-items: center; padding: .5rem; background: var(--bg-panel); border-radius: 4px; transition: background-color 0.2s; }
    .player-item:hover { background: #2d3748; }
    .player-item .pos-select { width: 80px; background: #0f172a; border: 1px solid var(--border-color); color: #fff; padding: .3rem; font-size: .9rem; border-radius: 4px; }
    .player-item .grab { cursor: grab; padding: .2rem .5rem; border-radius: 4px; background: rgba(255,255,255,.02); transition: background-color 0.2s; }
    .player-item .grab:hover { background: rgba(255,255,255,.05); }
    @keyframes shimmer { 0% { transform: translateX(-100%) skewX(-25deg); } 100% { transform: translateX(200%) skewX(-25deg); } }
    @keyframes dotPop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes ripple { 0% { transform: scale(0, 0); opacity: 1; } 20% { transform: scale(25, 25); opacity: 1; } 100% { opacity: 0; transform: scale(40, 40); } }
    .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
  </style>
</head>

<body>
  <div id="setup-screen">
    <div class="setup-box">
      <h2>2R Course α - 設定</h2>

      <div class="s-row">
        <div class="s-grp" style="flex:2;min-width:200px;">
          <label>グループ名</label>
          <input id="r-name" type="text" value="Group 1" />
        </div>

        <div class="s-grp">
          <label>勝ち抜けpt</label>
          <input id="r-win" type="number" value="5" />
        </div>

        <div class="s-grp">
          <label>勝ち抜け人数</label>
          <input id="r-slot" type="number" value="4" />
        </div>
      </div>

      <div class="s-row">
        <div class="s-grp">
          <label>休み</label>
          <input id="r-pen" type="number" value="5" />
        </div>

        <div class="s-grp">
          <label>誤答失格</label>
          <input id="r-max" type="number" value="0" />
        </div>

        <div class="s-grp">
          <label>問題開始番号</label>
          <input id="r-start" type="number" value="1" />
        </div>

        <div class="s-grp">
          <label>限定問題数</label>
          <input id="r-maxq" type="number" value="30" placeholder="0=無制限" />
        </div>
      </div>

      <div class="s-row" style="background:#0f172a;padding:1rem;border-radius:8px;border:1px solid var(--border-color);box-shadow:inset 0 2px 4px rgba(0,0,0,.2);">
        <div class="s-grp">
          <label>問題(CSV)</label>
          <input id="f-q" type="file" accept=".csv" style="padding: 0.4rem;" />
        </div>

        <div class="s-grp">
          <label>プレイヤー(CSV)</label>
          <input id="f-p" type="file" accept=".csv" style="padding: 0.4rem;" />
        </div>
      </div>

      <div id="player-list">
        <h3 style="margin-bottom:.5rem;font-size:.9rem;">参加者の配置設定</h3>
        <div id="player-list-content"></div>
      </div>

      <button class="btn-start" onclick="initGame()">GAME ON!</button>
    </div>
  </div>

  <div id="scoreboard-screen" style="display:none;flex-direction:column;height:100%;">
    <header>
      <div class="h-left">
        <div class="h-round">2nd Round / Course α</div>
        <div class="group-badge" id="d-group">GROUP 1</div>
      </div>

      <div class="h-center">
        <div class="h-rule" id="d-rule">5○3休</div>
      </div>

      <div class="h-right">
        <div class="q-badge">
          <span class="q-lbl" id="d-q-lbl">Q.</span>
          <span class="q-val" id="d-qnum">1</span>
        </div>

        <div class="q-badge" id="d-alive-slot" style="background: linear-gradient(135deg, #64748b, #475569);">0▶2</div>

        <img class="logo-img" src="https://github.com/astro-root/tokiwaji-open-2nd/blob/main/tokiwaji-open-2nd-logo.png?raw=true" alt="Logo" />
      </div>
    </header>

    <div id="question-area">
      <div class="q-ctrls">
        <button class="sys-btn" onclick="actUndo()">戻る</button>
        <button class="sys-btn" onclick="actThru()">スルー</button>
      </div>

      <div id="q-text" class="ph-q">ここに問題が表示されます</div>

      <div class="a-container">
        <span class="a-label">Ans.</span>
        <div id="a-text" class="ph-a">ここに解答が表示されます</div>
      </div>
    </div>

    <div id="main-content">
      <div id="players-container"></div>
    </div>
  </div>

  <script>
    let state = { qIdx: -1, qNum: 1, qs: [], seats: [], hist: [], done: false, winCnt: 0, domSeats: [] };
    let conf = { win: 5, pen: 3, slots: 2, maxX: 99, maxQ: 0, start: 1 };
    let rawP = [];
    let renderQueued = false;
    let schoolAdjustQueued = false;
    let resizeObserver = null;

    function parseCSV(t) {
      return t.trim().split('\n').map(l => {
        const r = [];
        const rx = /(?:,|^)(?:"([^"]*)"|([^",]*))/g;
        let m;
        while ((m = rx.exec(l)) !== null) {
          if (m.index === rx.lastIndex) rx.lastIndex++;
          r.push(m[1] || m[2] || "");
        }
        return r.filter(x => x !== undefined && x != "");
      });
    }

    document.getElementById('f-q').onchange = e => {
      const r = new FileReader();
      r.onload = v => {
        state.qs = parseCSV(v.target.result).map(x => ({ no: x[0], q: x[1], a: x[2] }));
        alert('問題を読み込みました');
      };
      r.readAsText(e.target.files[0]);
    };

    document.getElementById('f-p').onchange = e => {
      const r = new FileReader();
      r.onload = v => {
        rawP = parseCSV(v.target.result).map((x, i) => ({
          rank: x[0] || "",
          name: x[1] || ('Player ' + (i + 1)),
          sch: x[2] || "",
          gr: x[3] || "",
          col: x[4] || '#475569',
          pos: i + 1
        }));
        displayPlayerList();
        alert('参加者を読み込みました');
      };
      r.readAsText(e.target.files[0]);
    };

    function displayPlayerList() {
      const list = document.getElementById('player-list');
      const content = document.getElementById('player-list-content');
      list.style.display = 'block';
      content.innerHTML = '';
      const maxPos = Math.max(rawP.length, parseInt(document.getElementById('r-slot')?.value || 2));
      rawP.forEach((p, i) => {
        const item = document.createElement('div');
        item.className = 'player-item';
        item.draggable = true;
        item.dataset.index = i;
        const sel = document.createElement('select');
        sel.className = 'pos-select';
        for (let k = 1; k <= maxPos; k++) {
          const op = document.createElement('option');
          op.value = k;
          op.textContent = k;
          if (k === p.pos) op.selected = true;
          sel.appendChild(op);
        }
        sel.onchange = ev => { movePlayerTo(i, parseInt(ev.target.value) - 1); };
        item.ondragstart = ev => { ev.dataTransfer.setData('text/plain', String(i)); item.classList.add('dragging'); };
        item.ondragend = ev => { item.classList.remove('dragging'); };
        item.ondragover = ev => { ev.preventDefault(); };
        item.ondrop = ev => { ev.preventDefault(); const from = parseInt(ev.dataTransfer.getData('text/plain')); const to = parseInt(item.dataset.index); reorderPlayers(from, to); };
        const grab = document.createElement('div');
        grab.className = 'grab';
        grab.textContent = '≡';
        const span = document.createElement('span');
        span.style.flex = '1';
        span.textContent = `${p.rank} - ${p.name} (${p.sch})`;
        item.appendChild(sel);
        item.appendChild(grab);
        item.appendChild(span);
        content.appendChild(item);
      });
    }

    function reorderPlayers(from, to) {
      if (from === to) return;
      const moved = rawP.splice(from, 1)[0];
      rawP.splice(to, 0, moved);
      rawP.forEach((p, i) => p.pos = i + 1);
      displayPlayerList();
    }

    function movePlayerTo(index, targetIndex) {
      if (index === targetIndex) return;
      const item = rawP.splice(index, 1)[0];
      rawP.splice(targetIndex, 0, item);
      rawP.forEach((p, i) => p.pos = i + 1);
      displayPlayerList();
    }

    function fitTextToBox(el, maxSize, minSize) {
      if (!el) return;
      const cw = el.clientWidth, ch = el.clientHeight;
      if (cw <= 0 || ch <= 0) { el.style.fontSize = minSize + 'px'; return; }
      let low = minSize, high = maxSize, best = minSize;
      for (let i = 0; i < 8; i++) {
        const mid = Math.floor((low + high) / 2);
        el.style.fontSize = mid + 'px';
        const sw = el.scrollWidth, sh = el.scrollHeight;
        if (sw <= cw && sh <= ch) { best = mid; low = mid + 1; } else { high = mid - 1; }
      }
      el.style.fontSize = best + 'px';
    }

    function fitPlayerNames() {
      for (let i = 0; i < state.domSeats.length; i++) {
        const dom = state.domSeats[i];
        if (!dom || !dom.nameEl) continue;
        fitTextToBox(dom.nameEl, 64, 16);
      }
    }

    function adjustSchoolFonts() {
      if (schoolAdjustQueued) return;
      schoolAdjustQueued = true;
      requestAnimationFrame(() => {
        schoolAdjustQueued = false;
        for (let i = 0; i < state.domSeats.length; i++) {
          const dom = state.domSeats[i];
          if (!dom) continue;
          const head = dom.root.querySelector('.pc-head');
          const schEl = head ? head.querySelector('.pc-meta > div') : null;
          if (schEl) fitTextToBox(schEl, 16, 8);
        }
      });
    }

    function buildSeatElements() {
      const container = document.getElementById('players-container');
      container.innerHTML = '';
      state.domSeats = [];
      state.seats.forEach((p, i) => {
        const root = document.createElement('div');
        root.className = p ? 'p-card' : 'p-card slot-empty';
        root.dataset.index = i;
        if (!p) { container.appendChild(root); state.domSeats.push(null); return; }
        const head = document.createElement('div');
        head.className = 'pc-head';
        const rank = document.createElement('div');
        rank.className = 'pc-rank';
        rank.style.background = p.col || '#475569';
        rank.textContent = p.rank || '';
        const meta = document.createElement('div');
        meta.className = 'pc-meta';
        const sch = document.createElement('div');
        sch.textContent = p.sch || '';
        const gr = document.createElement('div');
        gr.textContent = p.gr || '';
        meta.appendChild(sch);
        meta.appendChild(gr);
        head.appendChild(rank);
        head.appendChild(meta);
        const body = document.createElement('div');
        body.className = 'pc-body';
        const towerEl = document.createElement('div');
        towerEl.className = 'pc-tower';
        const nameEl = document.createElement('div');
        nameEl.className = 'pc-name';
        nameEl.textContent = p.name || '';
        body.appendChild(towerEl);
        body.appendChild(nameEl);
        const overlayWin = document.createElement('div');
        overlayWin.className = 'pc-overlay-win';
        const overlayLose = document.createElement('div');
        overlayLose.className = 'pc-overlay-lose';
        const overlayRest = document.createElement('div');
        overlayRest.className = 'pc-overlay-rest';
        const restInner = document.createElement('div');
        restInner.className = 'rest-inner';
        const restNum = document.createElement('div');
        restNum.className = 'rest-num';
        restNum.textContent = '0';
        const restLbl = document.createElement('div');
        restLbl.className = 'rest-lbl';
        restLbl.textContent = 'RESTING';
        restInner.appendChild(restNum);
        restInner.appendChild(restLbl);
        overlayRest.appendChild(restInner);
        body.appendChild(overlayWin);
        body.appendChild(overlayLose);
        body.appendChild(overlayRest);
        const status = document.createElement('div');
        status.className = 'pc-status';
        const scoreEl = document.createElement('div');
        scoreEl.className = 'pc-score';
        scoreEl.textContent = p.sc || 0;
        const wrongs = document.createElement('div');
        wrongs.className = 'pc-wrongs';
        status.appendChild(scoreEl);
        status.appendChild(wrongs);
        const actions = document.createElement('div');
        actions.className = 'pc-actions';
        const btnO = document.createElement('button');
        btnO.className = 'btn-act btn-o';
        btnO.textContent = '○';
        const btnX = document.createElement('button');
        btnX.className = 'btn-act btn-x';
        btnX.textContent = '×';
        btnO.addEventListener('click', () => actO(i));
        btnX.addEventListener('click', () => actX(i));
        actions.appendChild(btnO);
        actions.appendChild(btnX);
        root.appendChild(head);
        root.appendChild(body);
        root.appendChild(status);
        root.appendChild(actions);
        container.appendChild(root);
        state.domSeats.push({ root, nameEl, scoreEl, wrongs, btnO, btnX, overlayWin, overlayLose, overlayRest, restNum, towerEl });
      });
      requestAnimationFrame(() => { fitPlayerNames(); adjustSchoolFonts(); });
      if (window.ResizeObserver && !resizeObserver) {
        resizeObserver = new ResizeObserver(() => { fitPlayerNames(); adjustSchoolFonts(); });
        resizeObserver.observe(document.getElementById('players-container'));
      }
    }

    function scheduleRender() {
      if (renderQueued) return;
      renderQueued = true;
      requestAnimationFrame(() => { renderQueued = false; render(); });
    }

    function initGame() {
      conf.win = parseInt(document.getElementById('r-win').value) || 5;
      conf.pen = parseInt(document.getElementById('r-pen').value) || 3;
      conf.slots = parseInt(document.getElementById('r-slot').value) || 2;
      conf.maxX = parseInt(document.getElementById('r-max').value) || 99;
      conf.maxQ = parseInt(document.getElementById('r-maxq').value) || 0;
      const startVal = parseInt(document.getElementById('r-start').value) || 1;
      conf.start = startVal;
      state.qNum = startVal;
      state.qIdx = -1;
      document.getElementById('d-group').innerText = document.getElementById('r-name').value;
      document.getElementById('d-rule').innerText = `${conf.win}○${conf.pen}休` + (conf.maxX < 20 ? ` ${conf.maxX}×` : '');
      const maxPos = Math.max(rawP.length, conf.slots);
      state.seats = Array(maxPos).fill(null);
      rawP.forEach((p, i) => {
        const idx = p.pos - 1;
        if (idx >= 0 && idx < state.seats.length) {
          state.seats[idx] = { ...p, sc: 0, wr: 0, rest: 0, lq: -1, st: 'active', wRank: 0 };
        }
      });
      const setup = document.getElementById('setup-screen');
      setup.style.opacity = '0';
      setTimeout(() => {
          setup.style.display = 'none';
          document.getElementById('scoreboard-screen').style.display = 'flex';
          buildSeatElements();
          scheduleRender();
      }, 500);
    }

    function getRankStr(n) {
      const s = ['th', 'st', 'nd', 'rd'];
      const v = n % 100;
      return s[(v - 20) % 10] || s[v] || s[0];
    }

    function ordinal(n) {
      const v = n % 100;
      if (v >= 11 && v <= 13) return n + 'th';
      const m = n % 10;
      if (m === 1) return n + 'st';
      if (m === 2) return n + 'nd';
      if (m === 3) return n + 'rd';
      return n + 'th';
    }

    function triggerAnimation(el, cls) {
        el.classList.remove(cls);
        void el.offsetWidth;
        el.classList.add(cls);
        setTimeout(() => el.classList.remove(cls), 500);
    }

    function render() {
      const wins = state.seats.filter(x => x && x.st === 'won').length;
      const valids = state.seats.filter(x => x).length;
      const lost = state.seats.filter(x => x && x.st === 'lost').length;
      const questionsUsed = state.qNum - conf.start;
      const reachedMaxQ = conf.maxQ > 0 && questionsUsed >= conf.maxQ;
      state.done = (wins >= conf.slots) || reachedMaxQ;
      const qLabel = document.getElementById('d-q-lbl');
      const qVal = document.getElementById('d-qnum');
      if (state.done) {
        qLabel.innerText = 'Q.';
        qVal.innerText = 'Finish';
        qVal.classList.add('finish');
      } else {
        qLabel.innerText = 'Q.';
        if(qVal.innerText !== String(state.qNum)) triggerAnimation(qVal, 'pop');
        qVal.innerText = state.qNum;
        qVal.classList.remove('finish');
      }
      const totalParticipants = valids;
      const left = Math.max(0, totalParticipants - wins - lost);
      const right = Math.max(0, conf.slots - wins);
      const aliveSlotEl = document.getElementById('d-alive-slot');
      if (aliveSlotEl) aliveSlotEl.innerText = String(left) + '▶' + String(right);
      const qEl = document.getElementById('q-text');
      const aEl = document.getElementById('a-text');
      if (state.qIdx === -1) {
        qEl.innerText = 'ここに問題が表示されます';
        if(!qEl.classList.contains('ph-q')) qEl.classList.add('ph-q');
        aEl.innerText = 'ここに解答が表示されます';
        if(!aEl.classList.contains('ph-a')) aEl.classList.add('ph-a');
      } else {
        qEl.classList.remove('ph-q');
        aEl.classList.remove('ph-a');
        if (state.qs.length > 0) {
          const len = state.qs.length;
          const idx = ((state.qIdx % len) + len) % len;
          const d = state.qs[idx];
          if (qEl.innerText !== (d.q || 'NO DATA')) qEl.innerText = d.q || 'NO DATA';
          if (aEl.innerText !== (d.a || '')) aEl.innerText = d.a || '';
        } else {
          qEl.innerText = 'NO DATA';
          aEl.innerText = '';
        }
      }
      for (let i = 0; i < state.seats.length; i++) {
        const p = state.seats[i];
        const dom = state.domSeats[i];
        if (!dom) continue;
        if (!p) {
          dom.root.className = 'p-card slot-empty';
          if (dom.nameEl) dom.nameEl.textContent = '';
          dom.scoreEl.textContent = '';
          dom.wrongs.innerHTML = '';
          dom.btnO.disabled = true;
          dom.btnX.disabled = true;
          dom.root.classList.remove('state-win', 'state-lost', 'state-rest');
          dom.towerEl.style.height = '0%';
          continue;
        }
        dom.root.classList.remove('slot-empty');
        dom.nameEl.textContent = p.name;
        fitTextToBox(dom.nameEl, 64, 16);
        const scoreText = (p.st === 'won') ? (ordinal(p.wRank)) : (p.sc + '');
        if (dom.scoreEl.textContent !== scoreText) dom.scoreEl.textContent = scoreText;
        const currentWrongs = dom.wrongs.children.length;
        const targetWrongs = Math.min(p.wr, 12);
        if (currentWrongs < targetWrongs) {
             for (let k = currentWrongs; k < targetWrongs; k++) {
                const dot = document.createElement('div');
                dot.className = 'w-dot on pop-in';
                dom.wrongs.appendChild(dot);
            }
        } else if (currentWrongs > targetWrongs) {
            dom.wrongs.innerHTML = '';
            for (let k = 0; k < targetWrongs; k++) {
                const dot = document.createElement('div');
                dot.className = 'w-dot on';
                dom.wrongs.appendChild(dot);
            }
        }
        dom.root.classList.remove('state-win', 'state-lost', 'state-rest', 'is-win');
        dom.scoreEl.classList.remove('won');
        dom.towerEl.style.background = '';
        if (p.st === 'won') {
          dom.root.classList.add('state-win', 'is-win');
          dom.btnO.disabled = true;
          dom.btnX.disabled = true;
          dom.scoreEl.classList.add('won');
          dom.towerEl.style.height = '100%';
          dom.towerEl.style.background = 'linear-gradient(to top, rgba(245, 158, 11, 0.6), rgba(245, 158, 11, 0.2))';
        } else if (p.st === 'lost') {
          dom.root.classList.add('state-lost');
          dom.btnO.disabled = true;
          dom.btnX.disabled = true;
        } else if (p.st === 'rest') {
          dom.root.classList.add('state-rest');
          dom.restNum.textContent = p.rest;
          dom.btnO.disabled = false;
          dom.btnX.disabled = false;
          const winPt = conf.win || 5;
          const pct = Math.min(100, Math.max(0, (p.sc / winPt) * 100));
          dom.towerEl.style.height = pct + '%';
        } else {
          dom.btnO.disabled = false;
          dom.btnX.disabled = false;
          const winPt = conf.win || 5;
          const pct = Math.min(100, Math.max(0, (p.sc / winPt) * 100));
          dom.towerEl.style.height = pct + '%';
        }
      }
      adjustSchoolFonts();
    }

    function save() {
      state.hist.push(JSON.stringify({ qIdx: state.qIdx, qNum: state.qNum, seats: state.seats, done: state.done, winCnt: state.winCnt }));
      if (state.hist.length > 20) state.hist.shift();
    }

    function actO(i) {
      if (state.done) return;
      save();
      let firstPress = false;
      if (state.qIdx === -1) {
        state.qIdx = conf.start - 1;
        firstPress = true;
        render();
      }
      const p = state.seats[i];
      if (!p || p.st === 'lost' || p.st === 'won') return;
      triggerAnimation(state.domSeats[i].scoreEl, 'pop');
      p.sc++;
      if (p.sc >= conf.win) {
        state.winCnt++;
        p.st = 'won';
        p.wRank = state.winCnt;
        p.rest = 0;
        p.rank = ordinal(p.wRank);
      }
      scheduleRender();
      if (!firstPress) nextQ();
    }

    function actX(i) {
      if (state.done) return;
      save();
      let firstPress = false;
      if (state.qIdx === -1) {
        state.qIdx = conf.start - 1;
        firstPress = true;
        render();
      }
      const p = state.seats[i];
      if (!p || p.st === 'lost' || p.st === 'won') return;
      triggerAnimation(state.domSeats[i].scoreEl, 'pop');
      p.wr++;
      if (p.wr >= conf.maxX) {
        p.st = 'lost';
        triggerAnimation(state.domSeats[i].root, 'animate-shake');
      } else {
        p.rest = conf.pen;
        p.st = 'rest';
        p.lq = state.qNum;
      }
      scheduleRender();
      if (!firstPress) nextQ();
    }

    function actThru() {
      if (state.done) return;
      save();
      let firstPress = false;
      if (state.qIdx === -1) {
        state.qIdx = conf.start - 1;
        firstPress = true;
        render();
      }
      scheduleRender();
      if (!firstPress) nextQ();
    }

    function nextQ() {
      const qEl = document.getElementById('q-text');
      const aEl = document.getElementById('a-text');
      qEl.classList.add('fade-out');
      aEl.classList.add('fade-out');
      setTimeout(() => {
          const currentQ = state.qNum;
          state.seats.forEach(p => {
            if (p && p.st === 'rest') {
              if (p.lq === currentQ) {
              } else {
                p.rest--;
                if (p.rest <= 0) {
                  p.rest = 0;
                  p.st = 'active';
                }
              }
            }
          });
          state.qIdx++;
          state.qNum++;
          qEl.classList.remove('fade-out');
          aEl.classList.remove('fade-out');
          scheduleRender();
      }, 250);
    }

    function actUndo() {
      if (!state.hist.length) return;
      const prev = JSON.parse(state.hist.pop());
      state.qIdx = prev.qIdx;
      state.qNum = prev.qNum;
      state.seats = prev.seats;
      state.done = prev.done;
      state.winCnt = prev.winCnt;
      buildSeatElements();
      scheduleRender();
    }
  </script>
</body>
</html>